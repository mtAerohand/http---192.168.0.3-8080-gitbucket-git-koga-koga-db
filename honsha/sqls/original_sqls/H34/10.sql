-- SQL_GET_FAX
SELECT A.管理No ,A.作業区コード ,COALESCE(B.作業区名,'') AS 作業区名 ,A.作業区担当者名 ,A.担当者コード ,COALESCE(C.社員名,'') AS 担当者名 ,D.受注番号 ,D.品名 ,D.品番 ,D.設変番号 ,CASE WHEN E.依頼書種別 = '1' THEN '' ELSE CAST(E.工程順序No as VARCHAR) END AS 工程順序No ,CASE WHEN E.依頼書種別 = '1' THEN '' ELSE F.作業区コード END AS 作業区コード ,CASE WHEN E.依頼書種別 = '1' THEN '' ELSE COALESCE(G.作業区略称,'') END AS 作業区名 ,F.工程コード ,COALESCE(H.工程略称,'') AS 工程名 ,F.納期 ,E.希望納入日 ,COALESCE(J.受入日, I.回答日) AS 前工程納期 ,E.希望納入数 ,E.依頼書種別 ,CASE WHEN E.依頼書種別 = '1' THEN CAST(E.希望納入日 as VARCHAR) ELSE CAST(A.先頭希望納入日 as VARCHAR) END AS SORT1 ,CASE WHEN E.依頼書種別 = '1' THEN D.品番 ELSE D.受注番号 END AS SORT2 ,CASE WHEN E.依頼書種別 = '1' THEN '' ELSE CAST(E.分納No as VARCHAR) END AS SORT3 ,CASE WHEN E.依頼書種別 = '1' THEN '' ELSE CAST(E.工程順序No as VARCHAR) END AS SORT4 ,D.枝番 FROM ( /* 通常 */ SELECT DISTINCT 管理No ,作業区コード ,作業区担当者名 ,担当者コード ,CAST(NULL AS DATE) AS 先頭希望納入日 FROM T_納期回答依頼 WHERE 回答依頼作成 = true AND 依頼書種別 = '1' AND 連絡手段 = '2' UNION ALL /* 多工程 */ SELECT c.管理No ,c.作業区コード ,c.作業区担当者名 ,c.担当者コード ,c.希望納入日 AS 先頭希望納入日 FROM ( SELECT 管理No ,MIN(工程順序No) AS 先頭工程順序No FROM T_納期回答依頼 WHERE 回答依頼作成 = true AND 依頼書種別 = '2' AND 連絡手段 = '2' GROUP BY 管理No ) AS a INNER JOIN ( SELECT 管理No ,工程順序No ,MIN(分納No) AS 先頭分納No FROM T_納期回答依頼 WHERE 回答依頼作成 = true AND 依頼書種別 = '2' GROUP BY 管理No, 工程順序No ) AS b ON b.管理No = a.管理No AND b.工程順序No = a.先頭工程順序No INNER JOIN T_納期回答依頼 AS c ON c.管理No = b.管理No AND c.工程順序No = b.工程順序No AND c.分納No = b.先頭分納No ) AS A LEFT OUTER JOIN M_作業区仕入先 AS B ON B.作業区コード = A.作業区コード LEFT OUTER JOIN M_社員 AS C ON C.社員コード = A.担当者コード INNER JOIN T_受注 AS D ON D.管理No = A.管理No INNER JOIN T_納期回答依頼 AS E ON E.管理No = A.管理No AND E.回答依頼作成 = true INNER JOIN T_生産計画詳細 AS F ON F.管理No = E.管理No AND F.工程順序No = E.工程順序No LEFT OUTER JOIN M_作業区仕入先 AS G ON G.作業区コード = F.作業区コード LEFT OUTER JOIN M_工程 AS H ON H.工程コード = F.工程コード LEFT OUTER JOIN T_納期回答依頼 AS I ON I.管理No = E.管理No AND I.工程順序No = (E.工程順序No - 1) AND I.分納No = E.分納No LEFT OUTER JOIN T_工程受入 AS J ON J.管理No = E.管理No AND J.工程順序No = (E.工程順序No - 1) AND J.分納No = E.分納No WHERE A.管理No
-- H34/796
IN (?)
-- SQL_GET_FAX_ORDER
ORDER BY SORT1, SORT2, SORT3, SORT4


