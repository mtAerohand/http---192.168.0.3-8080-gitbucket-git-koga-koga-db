-- SQL_CYCLE_BILLING_SUMMARY
INSERT INTO T_検収 ( 対象月 ,作業区コード ,前月残高 ,当月入金高 ,当月売上高_枚数 ,当月売上高_金額 ,当月売上高_消費税 ,材料支給高_枚数 ,材料支給高_金額 ,材料支給高_消費税 ,当月請求高 ,バージョン番号 ,更新日時 ,更新ユーザ名 ) SELECT * FROM ( SELECT ? AS 対象月 ,z.作業区コード ,z.前月残高（金額） ,z.当月入金高（金額） ,z.当月売上高（枚数） ,z.当月売上高（金額） ,z.当月売上高（消費税） ,z.材料支給高（枚数） ,z.材料支給高（金額） ,z.材料支給高（消費税） ,(z.前月残高（金額） - z.当月入金高（金額）) + (z.当月売上高（金額） + z.当月売上高（消費税）) - (z.材料支給高（金額） + z.材料支給高（消費税）) AS 差引当月請求高 ,1 AS バージョン番号 ,CURRENT_TIMESTAMP AS 更新日時 ,? AS 更新ユーザ名 FROM ( SELECT y.作業区コード ,SUM(y.前月残高（金額）) AS 前月残高（金額） ,SUM(y.当月入金高（金額）) AS 当月入金高（金額） ,SUM(y.当月売上高（枚数）) AS 当月売上高（枚数） ,SUM(y.当月売上高（金額）) AS 当月売上高（金額） ,CAST(ROUND(SUM(y.当月売上高（消費税）), 0) as BIGINT) AS 当月売上高（消費税） ,SUM(y.材料支給高（枚数）) + SUM(y.売上（枚数）) AS 材料支給高（枚数） ,SUM(y.材料支給高（金額）) + SUM(y.売上（金額）) AS 材料支給高（金額） ,CAST(ROUND(SUM(y.材料支給高（消費税）) + SUM(y.売上（消費税）), 0) as BIGINT) AS 材料支給高（消費税） FROM ( SELECT x.作業区コード ,CASE WHEN x.区分 = 1 THEN x.金額 ELSE 0 END AS 前月残高（金額） ,CASE WHEN x.区分 = 2 THEN x.金額 ELSE 0 END AS 当月入金高（金額） ,CASE WHEN x.区分 = 3 THEN x.件数 ELSE 0 END AS 当月売上高（枚数） ,CASE WHEN x.区分 = 3 THEN x.金額 ELSE 0 END AS 当月売上高（金額） ,CASE WHEN x.区分 = 4 THEN x.件数 ELSE 0 END AS 材料支給高（枚数） ,CASE WHEN x.区分 = 4 THEN x.金額 ELSE 0 END AS 材料支給高（金額） ,CASE WHEN x.区分 = 5 THEN x.件数 ELSE 0 END AS 売上（枚数） ,CASE WHEN x.区分 = 5 THEN x.金額 ELSE 0 END AS 売上（金額） ,CASE WHEN x.区分 = 3 THEN x.金額 * (CASE WHEN x.対象月 < '201910' THEN 0.08 ELSE 0.1 END) ELSE 0 END AS 当月売上高（消費税） ,CASE WHEN x.区分 = 4 THEN x.金額 * (CASE WHEN x.対象月 < '201910' THEN 0.08 ELSE 0.1 END) ELSE 0 END AS 材料支給高（消費税） ,CASE WHEN x.区分 = 5 THEN x.金額 * (CASE WHEN x.対象月 < '201910' THEN 0.08 ELSE 0.1 END) ELSE 0 END AS 売上（消費税） FROM ( SELECT A.作業区コード ,1 AS 区分 ,0 AS 件数 ,A.当月請求高 AS 金額 ,A.対象月 FROM T_検収 AS A WHERE A.対象月 = LEFT(TO_CHAR((CAST(? as DATE) + interval '-1 month') ,'YYYYMMDD'),6) UNION ALL SELECT B.作業区コード ,2 AS 区分 ,0 AS 件数 ,SUM(B.金額) AS 金額 ,B.対象月 FROM T_支払 AS B WHERE B.対象月 = LEFT(TO_CHAR((CAST(? as DATE) + interval '-1 month') ,'YYYYMMDD'),6) GROUP BY B.作業区コード, B.対象月 UNION ALL SELECT C.作業区コード ,C.区分 ,SUM(C.件数) AS 件数 ,SUM(C.金額) AS 金額 ,C.対象月 FROM ( SELECT 3 AS 区分 ,c1.作業区コード ,CAST(COUNT(a1.伝票番号) AS INT) AS 件数 ,SUM(a1.金額) AS 金額 ,TO_CHAR(a1.受入日, 'YYYYMM') AS 対象月 FROM T_工程受入 AS a1 INNER JOIN T_発注 AS c1 ON c1.伝票番号 = a1.伝票番号 WHERE a1.受入日 BETWEEN CAST(? as DATE) AND (CAST(? as DATE) + interval '1 month' ) - interval '1 day' GROUP BY c1.作業区コード, TO_CHAR(a1.受入日, 'YYYYMM') UNION ALL SELECT 3 AS 区分 ,a2.作業区コード ,CAST(COUNT(a2.作業区コード) AS INT) AS 件数 ,- SUM(a2.金額) AS 金額 ,TO_CHAR(a2.返品日, 'YYYYMM') AS 対象月 FROM T_受入返品 AS a2 WHERE a2.返品日 BETWEEN CAST(? as DATE) AND (CAST(? as DATE) + interval '1 month' ) - interval '1 day' GROUP BY a2.作業区コード, TO_CHAR(a2.返品日, 'YYYYMM') UNION ALL SELECT 3 AS 区分 ,a3.仕入先コード AS 作業区コード ,CAST(COUNT(a3.仕入先コード) AS INT) AS 件数 ,SUM(a3.金額) AS 金額 ,a3.対象月 FROM ( SELECT 仕入先コード ,取引日 ,CASE WHEN 取引区分 = '1' THEN 金額 ELSE - 金額 END AS 金額 ,TO_CHAR(取引日, 'YYYYMM') AS 対象月 FROM T_仕入 ) AS a3 WHERE a3.取引日 BETWEEN CAST(? as DATE) AND (CAST(? as DATE) + interval '1 month' ) - interval '1 day' GROUP BY a3.仕入先コード, a3.対象月 UNION ALL SELECT 4 AS 区分 ,a4.支給先コード AS 作業区コード ,CAST(COUNT(a4.支給先コード) AS INT) AS 件数 ,SUM(a4.支給金額) AS 金額 ,a4.対象月 FROM ( SELECT a4.支給先コード ,a4.取引日 ,CASE WHEN a4.取引区分 = '1' AND a4.相殺方法 = '1' THEN a4.支給金額 WHEN a4.取引区分 = '1' AND a4.相殺方法 = '2' THEN c4.相殺金額 ELSE - a4.支給金額 END AS 支給金額 ,TO_CHAR(CASE WHEN a4.取引区分 = '1' AND a4.相殺方法 = '2' THEN c4.相殺日 ELSE a4.取引日 END, 'YYYYMM') AS 対象月 FROM T_仕入 AS a4 LEFT OUTER JOIN T_仕入相殺 AS c4 ON c4.SeqNo = a4.SeqNo WHERE a4.取引分類 = '1' AND CASE WHEN a4.取引区分 = '1' AND a4.相殺方法 = '2' THEN c4.相殺日 ELSE a4.取引日 + interval '1 month' END BETWEEN CAST(? as DATE) AND (CAST(? as DATE) + interval '1 month' ) - interval '1 day' ) AS a4 GROUP BY a4.支給先コード, a4.対象月 UNION ALL SELECT 5 AS 区分 ,a5.取引先コード AS 作業区コード ,CAST(COUNT(a5.取引先コード) AS INT) AS 件数 ,SUM(a5.金額) AS 金額 ,TO_CHAR(a5.売上日, 'YYYYMM') AS 対象月 FROM T_売上任意 AS a5 WHERE a5.取引先区分 = '2' AND a5.売上日 BETWEEN CAST(? as DATE) AND (CAST(? as DATE) + interval '1 month' ) - interval '1 day' GROUP BY a5.取引先コード, TO_CHAR(a5.売上日, 'YYYYMM') ) AS C INNER JOIN M_作業区仕入先 AS D ON D.作業区コード = C.作業区コード AND D.検収書発行区分 = true GROUP BY C.作業区コード, C.区分, C.対象月 ) AS x ) AS y GROUP BY y.作業区コード ) AS z ) AS w WHERE w.差引当月請求高 <> 0 OR w.当月売上高（金額） <> 0 OR w.材料支給高（金額） <> 0
