-- SQL_CYCLE_BILLING_DETAIL
INSERT INTO T_検収明細( 対象月 ,作業区コード ,取引日 ,受注番号 ,枝番 ,品番材質 ,設変番号 ,明細区分 ,数量重量 ,単価 ,金額 ,備考 ,バージョン番号 ,更新日時 ,更新ユーザ名) SELECT ? AS 対象月 ,A.作業区コード ,A.取引日 ,A.受注番号 ,A.枝番 ,A.品番材質 ,A.設変番号 ,A.明細区分 ,A.数量重量 ,A.単価 ,A.金額 ,A.備考 ,1 AS バージョン番号 ,CURRENT_TIMESTAMP AS 更新日時 ,? AS 更新ユーザ名 FROM ( SELECT c1.作業区コード ,a1.受入日 AS 取引日 ,b1.受注番号 ,b1.枝番 ,b1.品番 AS 品番材質 ,b1.設変番号 ,CASE WHEN a1.受入形態区分 IN ('2','3') THEN '4' ELSE '1' END AS 明細区分 ,a1.受入数 AS 数量重量 ,a1.単価 ,a1.金額 ,'' AS 備考 FROM T_工程受入 AS a1 INNER JOIN T_受注 AS b1 ON b1.管理No = a1.管理No INNER JOIN T_発注 AS c1 ON c1.伝票番号 = a1.伝票番号 WHERE a1.受入日 BETWEEN CAST(? as DATE) AND (CAST(? as DATE) + interval '1 month' ) - interval '1 day' UNION ALL SELECT a2.作業区コード ,a2.返品日 AS 取引日 ,b2.受注番号 ,b2.枝番 ,b2.品番 AS 品番材質 ,b2.設変番号 ,'3' AS 明細区分 ,a2.数量 AS 数量重量 ,a2.単価 ,- a2.金額 AS 金額 ,a2.備考 FROM T_受入返品 AS a2 INNER JOIN T_受注 AS b2 ON b2.管理No = a2.管理No WHERE a2.返品日 BETWEEN CAST(? as DATE) AND (CAST(? as DATE) + interval '1 month' ) - interval '1 day' UNION ALL SELECT a3.仕入先コード AS 作業区コード ,a3.取引日 ,'' AS 受注番号 ,'' AS 枝番 ,CASE WHEN a3.取引分類 = '1' THEN a3.材質名 ELSE a3.品番 END AS 品番材質 ,a3.設変番号 ,CASE WHEN a3.取引区分 = '1' THEN '1' ELSE '3' END AS 明細区分 ,CASE WHEN a3.取引分類 = '1' THEN a3.重量 ELSE a3.数量 END AS 数量重量 ,a3.単価 ,CASE WHEN a3.取引区分 = '1' THEN a3.金額 ELSE - a3.金額 END AS 金額 ,a3.備考 FROM T_仕入 AS a3 WHERE a3.取引日 BETWEEN CAST(? as DATE) AND (CAST(? as DATE) + interval '1 month' ) - interval '1 day' UNION ALL SELECT a4.支給先コード AS 作業区コード ,a4.取引日 ,'' AS 受注番号 ,'' AS 枝番 ,a4.材質名 AS 品番材質 ,'' AS 設変番号 ,'2' AS 明細区分 ,CASE WHEN a4.取引区分 = '1' AND a4.相殺方法 = '2' THEN c4.重量 ELSE a4.重量 END AS 数量重量 ,a4.単価 ,CASE WHEN a4.取引区分 = '1' AND a4.相殺方法 = '1' THEN - a4.支給金額 WHEN a4.取引区分 = '1' AND a4.相殺方法 = '2' THEN - c4.相殺金額 ELSE a4.支給金額 END AS 金額 ,COALESCE(b4.作業区略称,'') AS 備考 FROM T_仕入 AS a4 LEFT OUTER JOIN M_作業区仕入先 AS b4 ON b4.作業区コード = a4.仕入先コード LEFT OUTER JOIN T_仕入相殺 AS c4 ON c4.SeqNo = a4.SeqNo WHERE a4.取引分類 = '1' AND CASE WHEN a4.取引区分 = '1' AND a4.相殺方法 = '2' THEN c4.相殺日 ELSE a4.取引日 + interval '1 month' END BETWEEN CAST(? as DATE) AND (CAST(? as DATE) + interval '1 month' ) - interval '1 day' UNION ALL SELECT a5.取引先コード AS 作業区コード ,a5.売上日 AS 取引日 ,'' AS 受注番号 ,'' AS 枝番 ,a5.品番 AS 品番材質 ,a5.設変番号 ,'2' AS 明細区分 ,a5.数量 AS 数量重量 ,a5.単価 ,- a5.金額 AS 金額 ,'' AS 備考 FROM T_売上任意 AS a5 WHERE a5.取引先区分 = '2' AND a5.売上日 BETWEEN CAST(? as DATE) AND (CAST(? as DATE) + interval '1 month' ) - interval '1 day' ) AS A INNER JOIN M_作業区仕入先 AS B ON B.作業区コード = A.作業区コード AND B.検収書発行区分 = true ORDER BY A.作業区コード, A.取引日, A.品番材質


