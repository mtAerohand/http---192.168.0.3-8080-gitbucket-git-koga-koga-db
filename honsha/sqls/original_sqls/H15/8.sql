-- SQL_REPORT_SYUTSURYOKU
SELECT a.管理No,b.工程順序No,b.作業区コード,COALESCE(d.作業区名,'') AS 作業区名,CURRENT_DATE AS 発注日,b.納期,c.品番,c.設変番号,c.品名,c.受注番号,c.枝番,b.工程コード,COALESCE(e.工程名,'') AS 工程名,COALESCE(g.作業区名,'') AS 前工程作業区名,f.納期 AS 前工程納期,CASE WHEN h.作業区コード IS NULL THEN '古河（本社）' ELSE COALESCE(i.作業区名,'') END AS 次工程作業区名,0 AS 伝票番号,a.生産数 AS 発注数,c.単位,CASE WHEN b.加工費区分 = true OR b.材料費区分 = true THEN 0.00 ELSE b.加工費 + b.材料費 END AS 発注単価 ,CASE WHEN b.加工費区分 = true OR b.材料費区分 = true THEN 0 ELSE CAST(trunc((b.加工費 + b.材料費) * a.生産数,0) as BIGINT) END AS 発注金額 ,c.発注備考1,c.発注備考2,COALESCE(k.社員名,'') AS 担当者名,CASE WHEN l.品番 IS NULL THEN '0' ELSE '1' END AS 管理マーク,CASE WHEN c.受注区分 <> '4' THEN '0' ELSE '1' END AS 再納マーク,CASE c.再納区分 WHEN '1' THEN '不合格選別依頼' WHEN '2' THEN '不合格再処理' WHEN '3' THEN '不合格再製造' ELSE '' END AS 再納マーク種類 ,CASE WHEN h.作業区コード IS NULL THEN 1 ELSE 0 END AS 最終工程区分,b.材料費 FROM T_生産計画 AS a INNER JOIN T_生産計画詳細 AS b ON b.管理No = a.管理No INNER JOIN T_受注 AS c ON c.管理No = a.管理No LEFT OUTER JOIN M_作業区仕入先 AS d ON d.作業区コード = b.作業区コード LEFT OUTER JOIN M_工程 AS e ON e.工程コード = b.工程コード LEFT OUTER JOIN T_生産計画詳細 AS f ON f.管理No = b.管理No AND f.工程順序No = (b.工程順序No - 1) LEFT OUTER JOIN M_作業区仕入先 AS g ON g.作業区コード = f.作業区コード LEFT OUTER JOIN T_生産計画詳細 AS h ON h.管理No = b.管理No AND h.工程順序No = (b.工程順序No + 1) LEFT OUTER JOIN M_作業区仕入先 AS i ON i.作業区コード = h.作業区コード LEFT OUTER JOIN M_社員 AS k ON k.社員コード = c.担当者コード LEFT OUTER JOIN ( SELECT DISTINCT 品番 FROM T_図面 WHERE 図面種類 = '1' ) AS l ON l.品番 = c.品番 WHERE a.管理No = CAST(? AS INT) ORDER BY b.管理No, b.工程順序No


