-- SQL_GETHISTORYLIST_SELECT
SELECT * FROM ( SELECT b.品番 ,b.設変番号 ,COALESCE(c.品名,'') AS 品名 ,a.受入日 AS 入出庫日 ,'仕入' AS 受払区分 ,a.受入数 ,0 AS 払出数 ,b.受注番号 ,b.枝番 ,'' AS 備考 ,'' AS 棚番 ,4 AS 順位 ,CAST(NULL as TIMESTAMP) AS 更新日時 FROM T_工程受入 AS a INNER JOIN T_受注 AS b ON b.管理No = a.管理No AND b.品番 = ? AND b.設変番号 = ? INNER JOIN T_発注 AS d ON d.管理No = a.管理No AND d.工程順序No = a.工程順序No AND d.最終工程区分 = true LEFT OUTER JOIN M_部品 AS c ON c.品番 = b.品番 UNION ALL SELECT b.品番 ,b.設変番号 ,COALESCE(c.品名,'') AS 品名 ,a.納入日 AS 入出庫日 ,'売上' AS 受払区分 ,0 AS 受入数 ,a.依頼数 AS 払出数 ,b.受注番号 ,b.枝番 ,'' AS 備考 ,'' AS 棚番 ,2 AS 順位 ,CAST(NULL as TIMESTAMP) AS 更新日時 FROM T_売上 AS a INNER JOIN T_受注 AS b ON b.管理No = a.管理No AND b.品番 = ? AND b.設変番号 = ? LEFT OUTER JOIN M_部品 AS c ON c.品番 = b.品番 UNION ALL SELECT a.品番 ,a.設変番号 ,COALESCE(b.品名,'') AS 品名 ,a.登録日 AS 入出庫日 ,'調整' AS 受払区分 ,CASE WHEN a.調整数 > 0 THEN a.調整数 ELSE 0 END AS 受入数 ,CASE WHEN a.調整数 < 0 THEN ABS(a.調整数) ELSE 0 END AS 払出数 ,'' AS 受注番号 ,'' AS 枝番 ,a.備考 ,CASE WHEN a.棚番2 = '' THEN a.棚番1 ELSE a.棚番1 || '-' || a.棚番2 END AS 棚番 ,1 AS 順位 ,a.更新日時 FROM T_受払 AS a LEFT OUTER JOIN M_部品 AS b ON b.品番 = a.品番 WHERE a.品番 = ? AND a.設変番号 = ? UNION ALL SELECT b.品番 ,b.設変番号 ,COALESCE(c.品名,'') AS 品名 ,a.返品日 AS 入出庫日 ,'返品' AS 受払区分 ,0 AS 受入数 ,a.数量 AS 払出数 ,b.受注番号 ,b.枝番 ,'' AS 備考 ,'' AS 棚番 ,3 AS 順位 ,CAST(NULL as TIMESTAMP) AS 更新日時 FROM T_受入返品 AS a INNER JOIN T_受注 AS b ON b.管理No = a.管理No AND b.品番 = ? AND b.設変番号 = ? LEFT OUTER JOIN M_部品 AS c ON c.品番 = b.品番 ) AS x ORDER BY x.入出庫日 DESC, x.順位, x.更新日時 DESC
