-- SQL_SMC_GENPINHYOU
SELECT a.管理No ,a.分納No ,CASE b.注文データ区分 WHEN 'A' THEN COALESCE(c.現品票フォーム区分,'') WHEN 'K' THEN COALESCE(d.現品票フォーム区分,'') WHEN 'C' THEN COALESCE(d.現品票フォーム区分,'') ELSE '' END AS 現品票フォーム区分 ,CASE WHEN b.客先品番 = '' THEN b.品番 ELSE b.客先品番 END AS 品番 ,e.個数 AS 入数 ,e.梱包数 AS 箱数 ,f.出荷数 ,f.全箱数 ,b.納入場所名 ,CASE b.注文データ区分 WHEN 'A' THEN COALESCE(c.棚番,'') WHEN 'K' THEN COALESCE(d.棚番,'') WHEN 'C' THEN COALESCE(d.棚番,'') ELSE '' END AS 棚番 ,CASE WHEN STRPOS(b.納入場所名,'部品中継') <> 0 THEN '1' WHEN b.注文データ区分 = 'A' THEN COALESCE(c.中継有無,'') WHEN b.注文データ区分 IN ('K','C') THEN COALESCE(d.中継有無,'') ELSE '' END AS 中継有無 ,b.次工程名 ,b.品名 ,b.設変番号 ,a.納入日 ,b.請求元 ,CASE b.注文データ区分 WHEN 'A' THEN COALESCE(c.手配No,'') ELSE '' END AS 手配No ,CASE b.注文データ区分 WHEN 'A' THEN COALESCE(c.注文番号,'') WHEN 'K' THEN COALESCE(d.発行連番,'') WHEN 'C' THEN COALESCE(d.発行連番,'') ELSE '' END AS 注番 ,CASE b.注文データ区分 WHEN 'A' THEN CASE WHEN LENGTH(COALESCE(c.管理番号,'')) < 15 THEN SUBSTRING(COALESCE(c.管理番号,''), 4, 15) ELSE CASE WHEN LENGTH(RTRIM(COALESCE(c.工号,''))) = 0 THEN COALESCE(c.仕込NO,'') ELSE COALESCE(c.工号,'') END END WHEN 'K' THEN COALESCE(d.工号,'') WHEN 'C' THEN COALESCE(d.工号,'') ELSE '' END AS 工号 ,b.テーパーおねじ区分 ,CASE b.注文データ区分 WHEN 'A' THEN RIGHT(COALESCE(c.注文番号,''),3) WHEN 'K' THEN RIGHT(COALESCE(d.発行連番,''),3) WHEN 'C' THEN RIGHT(COALESCE(d.発行連番,''),3) ELSE '' END AS 注番2 ,CASE b.注文データ区分 WHEN 'A' THEN LEFT(COALESCE(c.帳票番号,''), 8) WHEN 'K' THEN COALESCE(d.発行連番,'') WHEN 'C' THEN COALESCE(d.発行連番,'') ELSE '' END AS 帳票番号 ,CASE b.注文データ区分 WHEN 'A' THEN RIGHT(COALESCE(c.帳票番号,''), 2) WHEN 'K' THEN '01' WHEN 'C' THEN '01' ELSE '' END AS 帳票番号追番 FROM T_売上 AS a INNER JOIN T_受注 AS b ON b.管理No = a.管理No LEFT OUTER JOIN T_購買伝票受注 AS c ON c.帳票番号 = b.注文バーコード番号 LEFT OUTER JOIN T_工号生産納入指示 AS d ON d.発行連番 = b.注文バーコード番号 INNER JOIN T_売上詳細 AS e ON e.管理No = a.管理No AND e.分納No = a.分納No INNER JOIN ( SELECT 管理No ,分納No ,SUM(個数 * 梱包数) AS 出荷数 ,SUM(梱包数) AS 全箱数 FROM T_売上詳細 GROUP BY 管理No, 分納No ) AS f ON f.管理No = a.管理No AND f.分納No = a.分納No WHERE (a.管理No = ? AND a.分納No = ?)
    -- SQL_SMC_GENPINHYOU_WHERE(n回繰り返し)
    OR (a.管理No = ? AND a.分納No = ?)
-- SQL_SMC_GENPINHYOU_ORDER
ORDER BY 現品票フォーム区分, b.品番, b.設変番号, a.管理No, a.分納No, e.SeqNo


