-- SQL_GET_ORDER
SELECT a.管理No ,a.受注番号 ,a.枝番 ,a.得意先コード ,COALESCE(b.得意先名,'') AS 得意先名 ,CASE WHEN a.得意先コード = '1' THEN '1' ELSE '0' END as 得意先区分 ,CASE a.受注区分 WHEN '1' THEN '先行手配' WHEN '2' THEN '受注' WHEN '3' THEN '受注' WHEN '4' THEN '再納' ELSE '' END AS 受注区分 ,a.品番 ,a.設変番号 ,a.品名 ,CASE WHEN i.品番 IS NULL THEN '' ELSE '管理図面' END AS 図面分類 ,a.客先品番 ,a.受注日 ,a.納期 ,CASE WHEN a.注文データ区分 = 'A' THEN COALESCE(c.営業納期,'') ELSE '' END AS 営業納期 ,a.受注数 ,CASE WHEN a.受注区分 IN ('1', '4') THEN a.受注数 - COALESCE(d.完了数,0) ELSE a.受注数 - COALESCE(e.納入数,0) END AS 受注残数 ,CASE WHEN a.受注区分 IN ('1', '4') /* 先行手配 */ THEN CASE WHEN g.管理No IS NULL /* 依頼無し */ THEN '' /* 依頼有り */ ELSE CASE WHEN g.検査区分 = false /* 検査無し */ THEN CASE g.納入形態区分 WHEN '11' THEN 'END' WHEN '12' THEN 'STP' WHEN '13' THEN 'ING' ELSE '' END /* 検査有り */ ELSE CASE g.検査結果区分 /* 未検査 */ WHEN '0' THEN '' /* 合格 */ WHEN '1' THEN CASE g.納入形態区分 WHEN '11' THEN 'END' WHEN '12' THEN 'STP' WHEN '13' THEN 'ING' ELSE '' END /* 不合格 */ WHEN '2' THEN '不合格' ELSE '' END END END /* 受注（計画無し）,受注（計画有り）,再納 */ ELSE CASE WHEN g.管理No IS NULL /* 依頼無し */ THEN '' /* 依頼有り */ ELSE CASE WHEN g.検査結果区分 = '2' /* 不合格 */ THEN '不合格' /* 不合格以外 */ ELSE CASE WHEN h.管理No IS NULL /* 売上無し */ THEN '' /* 売上有り */ ELSE CASE h.納入形態区分 WHEN '1' THEN '完納' WHEN '2' THEN '打切り' WHEN '3' THEN '分納' WHEN '4' THEN '過剰納入' ELSE '' END END END END END AS 納入形態 ,j.登録日 AS 回答メール送信日 ,COALESCE(k.在庫数,0) AS 在庫数 ,COALESCE(k.仮受在庫数,0) AS 仮受在庫数 ,COALESCE(k.在庫数,0) - COALESCE(k.出荷依頼数,0) AS 有効在庫数 ,a.担当者コード ,COALESCE(l.社員名,'') AS 担当者名 ,m.発注日 ,m.発注数 ,a.納入場所名 FROM T_受注 AS a LEFT OUTER JOIN M_得意先 AS b ON b.得意先コード = a.得意先コード LEFT OUTER JOIN T_購買伝票受注 AS c ON c.帳票番号 = a.注文バーコード番号 LEFT OUTER JOIN ( SELECT 管理No, SUM(依頼数) AS 完了数 FROM T_検査出荷依頼 WHERE 検査区分 = false OR (検査区分 = true AND 検査結果区分 = '1') /* 検査無し、合格 */ GROUP BY 管理No ) AS d ON d.管理No = a.管理No LEFT OUTER JOIN ( SELECT 管理No, SUM(依頼数) AS 納入数 FROM T_売上 GROUP BY 管理No ) AS e ON e.管理No = a.管理No LEFT OUTER JOIN ( SELECT 管理No, MAX(分納No) AS 分納No FROM T_検査出荷依頼 GROUP BY 管理No ) AS f ON f.管理No = a.管理No LEFT OUTER JOIN T_検査出荷依頼 AS g ON g.管理No = f.管理No AND g.分納No = f.分納No LEFT OUTER JOIN T_売上 AS h ON h.管理No = g.管理No AND h.分納No = g.分納No LEFT OUTER JOIN ( SELECT DISTINCT 品番 FROM T_図面 WHERE 図面種類 = '1' ) AS i ON i.品番 = a.品番 LEFT OUTER JOIN ( SELECT 管理No, MAX(登録日) AS 登録日 FROM T_納期回答メール GROUP BY 管理No ) AS j ON j.管理No = a.管理No LEFT OUTER JOIN M_在庫 AS k ON k.品番 = a.品番 AND k.設変番号 = a.設変番号 LEFT OUTER JOIN M_社員 AS l ON l.社員コード = a.担当者コード LEFT OUTER JOIN ( SELECT DISTINCT 管理No, 発注日, 発注数 FROM T_発注 ) AS m ON m.管理No = a.管理No WHERE a.管理No = CAST(? as INT)


