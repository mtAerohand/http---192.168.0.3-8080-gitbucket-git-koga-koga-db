-- SQL_GET_EDIT
SELECT a.管理No ,a.分納No ,b.受注番号 ,b.枝番 ,b.得意先コード ,COALESCE(c.得意先名,'') AS 得意先名 ,b.品番 ,b.設変番号 ,b.品名 ,b.担当者コード ,COALESCE(d.社員名,'') AS 担当者名 ,b.受注区分 ,CASE b.受注区分 WHEN '1' THEN '先行手配' WHEN '2' THEN '受注' WHEN '3' THEN '受注' ELSE '再納' END AS 受注区分名 ,a.出荷区分 ,a.振替受注番号 ,a.振替枝番 ,a.振替管理No ,a.検査区分 ,COALESCE(e.在庫数,0) - COALESCE(e.出荷依頼数,0) AS 有効在庫数 ,COALESCE(e.在庫数,0) AS 在庫数 ,COALESCE(e.仮受在庫数,0) AS 仮受在庫数 ,COALESCE(e.出荷依頼数,0) AS 出荷依頼数 ,b.受注数 - (COALESCE(g.検査有完了数,0) + COALESCE(h.検査無依頼数,0) + COALESCE(f.納入数,0)) AS 受注残数 ,b.受注数 ,b.受注日 ,a.生産数 ,COALESCE(l.作業区略称,'') AS 作業区名 ,k.受入日 ,a.依頼数 ,b.単位 ,a.納入形態区分 ,b.納期 ,a.回答日 ,a.納入日 ,a.検査成績書 ,a.梱包区分 ,a.出荷便区分 ,a.納入場所名 ,a.備考1 ,a.備考2 ,a.バージョン番号 FROM T_検査出荷依頼 AS a INNER JOIN T_受注 AS b ON b.管理No = a.管理No LEFT OUTER JOIN M_得意先 AS c ON c.得意先コード = b.得意先コード LEFT OUTER JOIN M_社員 AS d ON d.社員コード = b.担当者コード LEFT OUTER JOIN M_在庫 AS e ON e.品番 = b.品番 AND e.設変番号 = b.設変番号 LEFT OUTER JOIN ( /* 出荷有りの完了数 */ SELECT x.管理No, SUM(x.依頼数) AS 納入数 FROM T_売上 AS x INNER JOIN T_検査出荷依頼 AS y ON y.管理No = x.管理No AND y.分納No = x.分納No AND y.出荷区分 <> '0' GROUP BY x.管理No ) AS f ON f.管理No = a.管理No LEFT OUTER JOIN ( /* 出荷無し/検査有りの完了数 */ SELECT 管理No, SUM(依頼数) AS 検査有完了数 FROM T_検査出荷依頼 WHERE 出荷区分 = '0' AND 検査区分 = true AND 検査結果区分 <> '0' GROUP BY 管理No ) AS g ON g.管理No = a.管理No LEFT OUTER JOIN ( /* 出荷無し/検査無しの完了数 */ SELECT 管理No, SUM(依頼数) AS 検査無依頼数 FROM T_検査出荷依頼 WHERE 出荷区分 = '0' AND 検査区分 = false AND 分納No <> CAST(? as INT) GROUP BY 管理No ) AS h ON h.管理No = a.管理No LEFT OUTER JOIN T_発注 AS i ON i.管理No = (CASE WHEN a.振替管理No = 0 THEN a.管理No ELSE a.振替管理No END) AND i.最終工程区分 = true LEFT OUTER JOIN ( SELECT 管理No, 工程順序No, MAX(分納No) AS 分納No FROM T_工程受入 GROUP BY 管理No, 工程順序No ) AS j ON j.管理No = i.管理No AND j.工程順序No = i.工程順序No LEFT OUTER JOIN T_工程受入 AS k ON k.管理No = i.管理No AND k.工程順序No = i.工程順序No AND k.分納No = j.分納No LEFT OUTER JOIN M_作業区仕入先 AS l ON l.作業区コード = i.作業区コード WHERE a.管理No = CAST(? as INT) AND a.分納No = CAST(? as INT)


