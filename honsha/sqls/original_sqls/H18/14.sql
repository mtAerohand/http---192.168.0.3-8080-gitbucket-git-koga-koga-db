-- SQL_GET_NEW_KENSA
SELECT a.管理No ,COALESCE(b.分納No,0) + 1 AS 分納No ,a.受注番号 ,a.枝番 ,a.得意先コード ,COALESCE(c.得意先名,'') AS 得意先名 ,a.品番 ,a.設変番号 ,a.品名 ,a.担当者コード ,COALESCE(d.社員名,'') AS 担当者名 ,a.受注区分 ,CASE a.受注区分 WHEN '1' THEN '先行手配 ' WHEN '2' THEN '受注' WHEN '3' THEN '受注' ELSE '再納' END AS 受注区分名 ,'0' AS 出荷区分 ,'' AS 振替受注番号 ,'' AS 振替枝番 ,0 AS 振替管理No ,1 AS 検査区分 ,COALESCE(e.在庫数,0) - COALESCE(e.出荷依頼数,0) AS 有効在庫数 ,COALESCE(e.在庫数,0) AS 在庫数 ,COALESCE(e.仮受在庫数,0) AS 仮受在庫数 ,COALESCE(e.出荷依頼数,0) AS 出荷依頼数 ,a.受注数 - (COALESCE(g.検査有完了数,0) + COALESCE(h.検査無依頼数,0) + COALESCE(f.納入数,0)) AS 受注残数 ,a.受注数 ,a.受注日 ,COALESCE(n.受入数計,0) - COALESCE(o.依頼数計,0) AS 生産数 ,COALESCE(l.作業区略称,'') AS 作業区名 ,k.受入日 ,COALESCE(n.受入数計,0) - COALESCE(o.依頼数計,0) AS 依頼数 ,a.単位 ,'11' AS 納入形態区分 ,a.納期 ,m.回答日 ,NULL AS 納入日 ,0 AS 検査成績書 ,e.梱包区分 ,'1' AS 出荷便区分 ,a.納入場所名 ,a.依頼備考1 ,a.依頼備考2 ,0 AS バージョン番号 FROM T_受注 AS a LEFT OUTER JOIN( SELECT 管理No, MAX(分納No) AS 分納No FROM T_検査出荷依頼 GROUP BY 管理No ) AS b ON b.管理No = a.管理No LEFT OUTER JOIN M_得意先 AS c ON c.得意先コード = a.得意先コード LEFT OUTER JOIN M_社員 AS d ON d.社員コード = a.担当者コード LEFT OUTER JOIN M_在庫 AS e ON e.品番 = a.品番 AND e.設変番号 = a.設変番号 LEFT OUTER JOIN ( /* 出荷有りの完了数 */ SELECT x.管理No, SUM(x.依頼数) AS 納入数 FROM T_売上 AS x INNER JOIN T_検査出荷依頼 AS y ON y.管理No = x.管理No AND y.分納No = x.分納No AND y.出荷区分 <> '0' GROUP BY x.管理No ) AS f ON f.管理No = a.管理No LEFT OUTER JOIN ( /* 出荷無し/検査有りの完了数 */ SELECT 管理No, SUM(依頼数) AS 検査有完了数 FROM T_検査出荷依頼 WHERE 出荷区分 = '0' AND 検査区分 = true AND 検査結果区分 <> '0' GROUP BY 管理No ) AS g ON g.管理No = a.管理No LEFT OUTER JOIN ( /* 出荷無し/検査無しの完了数 */ SELECT 管理No, SUM(依頼数) AS 検査無依頼数 FROM T_検査出荷依頼 WHERE 出荷区分 = '0' AND 検査区分 = false GROUP BY 管理No ) AS h ON h.管理No = a.管理No LEFT OUTER JOIN T_発注 AS i ON i.管理No = a.管理No AND i.最終工程区分 = true LEFT OUTER JOIN ( SELECT 管理No, 工程順序No, MAX(分納No) AS 分納No FROM T_工程受入 GROUP BY 管理No, 工程順序No ) AS j ON j.管理No = i.管理No AND j.工程順序No = i.工程順序No LEFT OUTER JOIN T_工程受入 AS k ON k.管理No = i.管理No AND k.工程順序No = i.工程順序No AND k.分納No = j.分納No LEFT OUTER JOIN M_作業区仕入先 AS l ON l.作業区コード = i.作業区コード LEFT OUTER JOIN ( SELECT 管理No, 工程順序No, SUM(受入数) AS 受入数計 FROM T_工程受入 GROUP BY 管理No, 工程順序No ) AS n ON n.管理No = i.管理No AND n.工程順序No = i.工程順序No LEFT OUTER JOIN ( SELECT 管理No, SUM(依頼数) AS 依頼数計 FROM T_検査出荷依頼 WHERE 出荷区分 IN ('0','3') GROUP BY 管理No ) AS o ON o.管理No = i.管理No LEFT OUTER JOIN T_納期回答 AS m ON m.管理No = a.管理No AND m.分納No = COALESCE(b.分納No,0) + 1 WHERE a.管理No = CAST(? as INT)


