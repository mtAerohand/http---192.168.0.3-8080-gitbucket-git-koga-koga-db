-- SQL_REPORT_32_COUNT_TEMPLATE
SELECT CAST(COUNT(x.得意先コード) AS INT) %s %s
-- SQL_REPORT_32_COMMON(%s1)
FROM ( SELECT A.得意先コード ,CAST(COUNT(A.得意先コード) AS INT) AS 件数 ,SUM(A.金額) AS 売上金額 FROM ( SELECT b1.得意先コード ,a1.金額 FROM T_売上 AS a1 INNER JOIN T_受注 AS b1 ON b1.管理No = a1.管理No AND b1.受注区分 IN ('2','3') AND NOT (b1.得意先コード = '1' AND LEFT(b1.受注番号,1) ~ '^[0-9]+$') WHERE a1.納入日 BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) UNION ALL SELECT b2.得意先コード ,a2.金額 FROM T_売上 AS a2 INNER JOIN T_受注 AS b2 ON b2.管理No = a2.管理No LEFT OUTER JOIN M_得意先 AS c2 ON c2.得意先コード = b2.得意先コード LEFT OUTER JOIN T_工号生産納入指示 AS d2 ON d2.発行連番 = b2.注文バーコード番号 WHERE a2.納入日 BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) AND b2.受注区分 IN ('2','3') AND b2.得意先コード = '1' AND LEFT(b2.受注番号,1) ~ '^[0-9]+$' AND ((b2.納期 >= '2018-01-01' AND COALESCE(d2.次工程先コード,'') <> '') OR b2.納期 <= '2017-12-31') UNION ALL SELECT b3.得意先コード ,a3.金額 FROM T_売上 AS a3 INNER JOIN T_受注 AS b3 ON b3.管理No = a3.管理No AND b3.受注区分 IN ('2','3') AND b3.得意先コード = '1' AND LEFT(b3.受注番号,1) ~ '^[0-9]+$' AND b3.納期 >= '2018-01-01' LEFT OUTER JOIN T_工号生産納入指示 AS c3 ON c3.発行連番 = b3.注文バーコード番号 WHERE a3.納入日 BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) AND COALESCE(c3.次工程先コード,'') = '' UNION ALL SELECT a4.得意先コード ,- a4.金額 AS 金額 FROM T_売上返品 AS a4 LEFT OUTER JOIN M_部品 AS b4 ON b4.品番 = a4.品番 WHERE a4.返品日 BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) UNION ALL SELECT a5.取引先コード AS 得意先コード ,a5.金額 FROM T_売上任意 AS a5 WHERE a5.売上日 BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) AND a5.取引先区分 = '1' ) AS A GROUP BY A.得意先コード ) AS x LEFT OUTER JOIN M_得意先 AS y ON y.得意先コード = x.得意先コード
    -- SQL_REPORT_32_ORDERBY(%s2)
    ORDER BY COALESCE(y.表示順,0), x.得意先コード


