-- SQL_REPORT_41_SELECT_TEMPLATE
SELECT CASE A.区分 WHEN '1' THEN '加工' WHEN '2' THEN '加工返' WHEN '3' THEN '材料' WHEN '4' THEN '材料返' ELSE '売上' END AS 区分 ,A.作業区コード ,COALESCE(B.作業区名,'') AS 作業区名 ,A.受注番号,A.枝番,A.品番,A.設変番号,A.品名,A.日付 ,A.数量重量,A.単価,A.仕入金額,CASE A.受入形態区分 WHEN '1' THEN '完納' WHEN '2' THEN '打切り' WHEN '3' THEN '分納' ELSE '' END AS 受入形態 ,COALESCE(C.作業区略称,'') AS 材料仕入先名 FROM ( SELECT 1 AS 区分 ,c1.作業区コード,b1.受注番号,b1.枝番,b1.品番,b1.設変番号,b1.品名,a1.受入日 AS 日付 ,a1.受入数 AS 数量重量,a1.単価,a1.金額 AS 仕入金額,a1.受入形態区分,'' AS 材料仕入先コード FROM T_工程受入 AS a1 INNER JOIN T_受注 AS b1 ON b1.管理No = a1.管理No INNER JOIN T_発注 AS c1 ON c1.伝票番号 = a1.伝票番号 WHERE c1.作業区コード = ? AND a1.受入日 BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) UNION ALL SELECT 2 AS 区分 ,a2.作業区コード,b2.受注番号,b2.枝番,b2.品番,b2.設変番号,b2.品名,a2.返品日 AS 日付 ,a2.数量 AS 数量重量,a2.単価,- a2.金額 AS 仕入金額,'' AS 受入形態区分,'' AS 材料仕入先コード FROM T_受入返品 AS a2 INNER JOIN T_受注 AS b2 ON b2.管理No = a2.管理No WHERE a2.作業区コード = ? AND a2.返品日 BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) UNION ALL SELECT CASE WHEN a3.取引分類 = '1' THEN CASE WHEN a3.取引区分 = '1' THEN 3 ELSE 4 END ELSE CASE WHEN a3.取引区分 = '1' THEN 1 ELSE 2 END END AS 区分 ,a3.仕入先コード AS 作業区コード ,'' AS 受注番号 ,'' AS 枝番 ,CASE WHEN a3.取引分類 = '1' THEN a3.材質名 ELSE a3.品番 END AS 品番 ,CASE WHEN a3.取引分類 = '1' THEN '' ELSE a3.設変番号 END AS 設変番号 ,CASE WHEN a3.取引分類 = '1' THEN a3.形状 ELSE a3.品名 END AS 品名 ,a3.取引日 AS 日付 ,CASE WHEN a3.取引分類 = '1' THEN a3.重量 ELSE a3.数量 END AS 数量重量 ,a3.単価 ,CASE WHEN a3.取引区分 = '1' THEN a3.金額 ELSE - a3.金額 END AS 仕入金額 ,'' AS 受入形態区分 ,CASE WHEN a3.取引分類 = '1' THEN a3.支給先コード ELSE NULL END AS 材料仕入先コード FROM T_仕入 AS a3 WHERE a3.仕入先コード = ? AND a3.取引日 BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) UNION ALL SELECT CASE WHEN a4.取引区分 = '1' THEN 3 ELSE 4 END AS 区分 ,a4.支給先コード AS 作業区コード ,'' AS 受注番号 ,'' AS 枝番 ,a4.材質名 AS 品番 ,'' AS 設変番号 ,a4.形状 AS 品名 ,a4.取引日 AS 日付 ,CASE WHEN a4.取引区分 = '1' AND a4.相殺方法 = '2' THEN c4.重量 ELSE a4.重量 END AS 数量重量 ,a4.単価 ,CASE WHEN a4.取引区分 = '1' AND a4.相殺方法 = '1' THEN - a4.支給金額 WHEN a4.取引区分 = '1' AND a4.相殺方法 = '2' THEN - c4.相殺金額 ELSE a4.支給金額 END AS 仕入金額 ,'' AS 受入形態区分 ,a4.仕入先コード AS 材料仕入先コード FROM T_仕入 AS a4 LEFT OUTER JOIN T_仕入相殺 AS c4 ON c4.SeqNo = a4.SeqNo WHERE a4.取引分類 = '1' AND a4.支給先コード = ? AND CASE WHEN a4.取引区分 = '1' AND a4.相殺方法 = '2' THEN c4.相殺日 ELSE a4.取引日 + interval'1 month' END BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) UNION ALL SELECT 5 AS 区分 ,a5.取引先コード AS 作業区コード ,'' AS 受注番号,'' AS 枝番,a5.品番,a5.設変番号,a5.品名,a5.売上日 AS 日付 ,a5.数量 AS 数量重量,a5.単価,- a5.金額 AS 仕入金額,'' AS 受入形態区分,'' AS 材料仕入先コード FROM T_売上任意 AS a5 WHERE a5.取引先区分 = '2' AND a5.取引先コード = ? AND a5.売上日 BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) ) AS A LEFT OUTER JOIN M_作業区仕入先 AS B ON B.作業区コード = A.作業区コード LEFT OUTER JOIN M_作業区仕入先 AS C ON C.作業区コード = A.材料仕入先コード ORDER BY A.日付, A.区分, A.品番, A.設変番号


