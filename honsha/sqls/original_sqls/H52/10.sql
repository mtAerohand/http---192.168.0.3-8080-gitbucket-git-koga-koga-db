-- SQL_REPORT_43_SELECT
SELECT CASE A.区分 WHEN '1' THEN '材料' ELSE '材料返' END AS 区分 ,A.作業区コード ,COALESCE(B.作業区名,'') AS 作業区名 ,A.材質名 ,A.形状 ,A.日付 ,A.重量 ,A.材料単位 ,A.単価 ,A.仕入金額 ,COALESCE(C.作業区略称,'') AS 材料仕入先名 ,A.備考 FROM ( SELECT CASE WHEN a.取引区分 = '1' THEN 1 ELSE 2 END AS 区分 ,a.仕入先コード AS 作業区コード ,a.材質名 ,a.形状 ,a.取引日 AS 日付 ,a.重量 ,CASE WHEN a.材料単位 = '1' THEN 'kg' ELSE '本' END AS 材料単位 ,a.単価 ,CASE WHEN a.取引区分 = '1' THEN a.金額 ELSE - a.金額 END AS 仕入金額 ,a.支給先コード AS 材料仕入先コード ,a.備考 FROM T_仕入 AS a WHERE a.取引分類 = '1' AND a.仕入先コード = ? AND a.取引日 BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) UNION ALL SELECT CASE WHEN b.取引区分 = '1' THEN 1 ELSE 2 END AS 区分 ,b.支給先コード AS 作業区コード ,b.材質名 ,b.形状 ,b.取引日 AS 日付 ,CASE WHEN b.取引区分 = '1' AND b.相殺方法 = '2' THEN c.重量 ELSE b.重量 END AS 数量重量 ,CASE WHEN b.材料単位 = '1' THEN 'kg' ELSE '本' END AS 材料単位 ,b.単価 ,CASE WHEN b.取引区分 = '1' AND b.相殺方法 = '1' THEN - b.支給金額 WHEN b.取引区分 = '1' AND b.相殺方法 = '2' THEN - c.相殺金額 ELSE b.支給金額 END AS 仕入金額 ,b.仕入先コード AS 材料仕入先コード ,b.備考 FROM T_仕入 AS b LEFT OUTER JOIN T_仕入相殺 AS c ON c.SeqNo = b.SeqNo WHERE b.取引分類 = '1' AND b.支給先コード = ? AND CASE WHEN b.取引区分 = '1' AND b.相殺方法 = '2' THEN c.相殺日 ELSE b.取引日 + interval'1 month' END BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) ) AS A LEFT OUTER JOIN M_作業区仕入先 AS B ON B.作業区コード = A.作業区コード LEFT OUTER JOIN M_作業区仕入先 AS C ON C.作業区コード = A.材料仕入先コード ORDER BY A.日付, A.区分, A.材質名, A.形状


