-- SQL_REPORT_64_SELECT_TEMPLATE
SELECT * FROM ( SELECT DISTINCT c.品番 ,c.設変番号 ,c.品名 ,COALESCE(d.在庫数,0) AS 在庫数 ,CASE WHEN d.棚番1 IS NULL THEN '' ELSE CASE WHEN d.棚番2 = '' THEN d.棚番1 ELSE d.棚番1 || '-' || d.棚番2 END END AS 棚番 ,c.受注番号 ,c.枝番 ,a.受入数 AS 支給数 ,a.受入日 AS 支給日 ,CASE WHEN c.受注区分 IN ('1','4') THEN CASE WHEN f.管理No IS NULL THEN '' ELSE CASE WHEN f.検査区分 = false THEN CASE f.納入形態区分 WHEN '11' THEN 'END' WHEN '12' THEN 'STP' WHEN '13' THEN 'ING' ELSE '' END ELSE CASE f.検査結果区分 WHEN '0' THEN '依頼中' WHEN '1' THEN CASE f.納入形態区分 WHEN '11' THEN 'END' WHEN '12' THEN 'STP' WHEN '13' THEN 'ING' ELSE '' END WHEN '2' THEN '不合格' ELSE '' END END END ELSE CASE WHEN f.管理No IS NULL THEN '' ELSE CASE WHEN f.検査結果区分 = '2' THEN '不合格' ELSE CASE WHEN g.管理No IS NULL THEN '依頼中' ELSE CASE g.納入形態区分 WHEN '1' THEN '完納' WHEN '2' THEN '打切り' WHEN '3' THEN '分納' WHEN '4' THEN '過剰納入' ELSE '' END END END END END AS 状況 ,CASE WHEN c.受注区分 IN ('1','4') THEN CASE WHEN f.管理No IS NULL THEN NULL ELSE CASE WHEN f.検査区分 = false THEN NULL ELSE CASE f.検査結果区分 WHEN '0' THEN f.依頼日 ELSE NULL END END END ELSE CASE WHEN f.管理No IS NULL THEN NULL ELSE CASE WHEN f.検査結果区分 = '2' THEN NULL ELSE CASE WHEN g.管理No IS NULL THEN f.依頼日 ELSE NULL END END END END AS 依頼日 ,COALESCE(h.工程順序No, 0) AS 工程No ,COALESCE(i.作業区略称,'') AS 作業区名 ,COALESCE(j.受入数,0) AS 受入数 FROM T_工程受入 AS a INNER JOIN T_生産計画詳細 AS b ON b.管理No = a.管理No AND b.工程順序No = a.工程順序No AND b.作業区コード = '448' AND b.工程コード = '50' INNER JOIN T_受注 AS c ON c.管理No = a.管理No LEFT OUTER JOIN ( SELECT 品番 ,設変番号 ,在庫数 ,CASE 棚番1 WHEN '0' THEN '' WHEN '00' THEN '' ELSE 棚番1 END AS 棚番1 ,CASE 棚番2 WHEN '0' THEN '' WHEN '00' THEN '' ELSE 棚番2 END AS 棚番2 FROM M_在庫 ) AS d ON d.品番 = c.品番 AND d.設変番号 = c.設変番号 LEFT OUTER JOIN ( SELECT 管理No, MAX(分納No) AS 分納No FROM T_検査出荷依頼 GROUP BY 管理No ) AS e ON e.管理No = a.管理No LEFT OUTER JOIN T_検査出荷依頼 AS f ON f.管理No = e.管理No AND f.分納No = e.分納No LEFT OUTER JOIN T_売上 AS g ON g.管理No = f.管理No AND g.分納No = f.分納No LEFT OUTER JOIN T_発注 AS h ON h.管理No = a.管理No AND h.工程順序No <> a.工程順序No AND NOT EXISTS (SELECT * FROM T_工程受入 WHERE 管理No = h.管理No AND 工程順序No = h.工程順序No AND 受入形態区分 IN ('1','2')) LEFT OUTER JOIN M_作業区仕入先 AS i ON i.作業区コード = h.作業区コード LEFT OUTER JOIN ( SELECT 管理No ,工程順序No ,SUM(受入数) AS 受入数 FROM T_工程受入 GROUP BY 管理No, 工程順序No ) AS j ON j.管理No = h.管理No AND j.工程順序No = h.工程順序No WHERE a.受入日 BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) ) AS A WHERE A.在庫数 <> 0 OR A.状況 IN ('','ING','依頼中','分納') ORDER BY A.品番, A.設変番号, A.支給日, A.受注番号, A.枝番, A.工程No


