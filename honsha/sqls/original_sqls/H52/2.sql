-- SQL_REPORT_31_COUNT_TEMPLATE
SELECT CAST(COUNT(x.得意先コード) AS INT) %s %s
-- SQL_REPORT_31_COMMON(%s1)
FROM ( SELECT 1 AS データ種別 ,b1.得意先コード ,'売上' AS 区分 ,'' AS 分類 ,b1.受注番号 ,b1.枝番 ,b1.品番 ,b1.設変番号 ,b1.品名 ,b1.客先品番 ,a1.納入日 ,b1.納入場所名 ,CAST(NULL AS DATE) AS 返品日 ,b1.納期 ,a1.依頼数 AS 数量 ,a1.単価 ,a1.金額 ,CASE a1.納入形態区分 WHEN '1' THEN '完納' WHEN '2' THEN '打切り' WHEN '3' THEN '分納' WHEN '4' THEN '過剰納入' ELSE '' END AS 納入形態 ,'' AS 発行連番 FROM T_売上 AS a1 INNER JOIN T_受注 AS b1 ON b1.管理No = a1.管理No AND b1.受注区分 IN ('2','3') AND NOT (b1.得意先コード = '1' AND LEFT(b1.受注番号,1) ~ '^[0-9]+$') WHERE a1.納入日 BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) UNION ALL SELECT 2 AS データ種別 ,b2.得意先コード ,'売上' AS 区分 ,'工号' AS 分類 ,b2.受注番号 ,b2.枝番 ,b2.品番 ,b2.設変番号 ,b2.品名 ,b2.客先品番 ,a2.納入日 ,b2.納入場所名 ,CAST(NULL AS DATE) AS 返品日 ,b2.納期 ,a2.依頼数 AS 数量 ,a2.単価 ,a2.金額 ,CASE a2.納入形態区分 WHEN '1' THEN '完納' WHEN '2' THEN '打切り' WHEN '3' THEN '分納' WHEN '4' THEN '過剰納入' ELSE '' END AS 納入形態 ,c2.発行連番 FROM T_売上 AS a2 INNER JOIN T_受注 AS b2 ON b2.管理No = a2.管理No LEFT OUTER JOIN T_工号生産納入指示 AS c2 ON c2.発行連番 = b2.注文バーコード番号 WHERE a2.納入日 BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) AND b2.受注区分 IN ('2','3') AND b2.得意先コード = '1' AND LEFT(b2.受注番号,1) ~ '^[0-9]+$' AND ((b2.納期 >= '2018-01-01' AND COALESCE(c2.次工程先コード,'') <> '') OR b2.納期 <= '2017-12-31') UNION ALL SELECT 2 AS データ種別 ,b3.得意先コード ,'売上' AS 区分 ,'工号' AS 分類 ,b3.受注番号 ,b3.枝番 ,b3.品番 ,b3.設変番号 ,b3.品名 ,b3.客先品番 ,a3.納入日 ,b3.納入場所名 ,CAST(NULL AS DATE) AS 返品日 ,b3.納期 ,a3.依頼数 AS 数量 ,a3.単価 ,a3.金額 ,CASE a3.納入形態区分 WHEN '1' THEN '完納' WHEN '2' THEN '打切り' WHEN '3' THEN '分納' WHEN '4' THEN '過剰納入' ELSE '' END AS 納入形態 ,c3.発行連番 FROM T_売上 AS a3 INNER JOIN T_受注 AS b3 ON b3.管理No = a3.管理No AND b3.受注区分 IN ('2','3') AND b3.得意先コード = '1' AND LEFT(b3.受注番号,1) ~ '^[0-9]+$' AND b3.納期 >= '2018-01-01' LEFT OUTER JOIN T_工号生産納入指示 AS c3 ON c3.発行連番 = b3.注文バーコード番号 WHERE a3.納入日 BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) AND COALESCE(c3.次工程先コード,'') = '' UNION ALL SELECT 4 AS データ種別 ,a4.得意先コード ,'返品' AS 区分 ,'' AS 分類 ,'' AS 受注番号 ,'' AS 枝番 ,a4.品番 ,a4.設変番号 ,COALESCE(b4.品名,'') AS 品名 ,'' AS 客先品番 ,CAST(NULL AS DATE) AS 納入日 ,'' AS 納入場所名 ,a4.返品日 ,CAST(NULL AS DATE) AS 納期 ,- a4.数量 AS 数量 ,a4.単価 ,- a4.金額 AS 金額 ,'' AS 納入形態 ,'' AS 発行連番 FROM T_売上返品 AS a4 LEFT OUTER JOIN M_部品 AS b4 ON b4.品番 = a4.品番 WHERE a4.返品日 BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) UNION ALL SELECT 5 AS データ種別 ,a5.取引先コード ,'売上' AS 区分 ,'' AS 分類 ,'' AS 受注番号 ,'' AS 枝番 ,a5.品番 ,a5.設変番号 ,a5.品名 ,'' AS 客先品番 ,a5.売上日 AS 納入日 ,'' AS 納入場所名 ,CAST(NULL AS DATE) AS 返品日 ,CAST(NULL AS DATE) AS 納期 ,a5.数量 ,a5.単価 ,a5.金額 ,'' AS 納入形態 ,'' AS 発行連番 FROM T_売上任意 AS a5 WHERE a5.売上日 BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) AND a5.取引先区分 = '1' ) AS x LEFT OUTER JOIN M_得意先 AS y ON y.得意先コード = x.得意先コード WHERE x.得意先コード = ?
    -- SQL_REPORT_31_WHERE_HINBAN(%s2)
    AND x.品番 &^ ?
    -- SQL_REPORT_31_ORDERBY(%s3)
    ORDER BY CASE データ種別 WHEN 4 THEN x.返品日 ELSE x.納入日 END ,x.データ種別 ,x.品番 ,x.受注番号


