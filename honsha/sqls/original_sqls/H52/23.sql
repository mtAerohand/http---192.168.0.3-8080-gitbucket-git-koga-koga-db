-- SQL_REPORT_22_COUNT_TEMPLATE
SELECT CAST(COUNT(A.作業区コード) AS INT) %s %s
    -- SQL_REPORT_22_COMMON(%s1)
    FROM( SELECT 作業区コード ,CAST(COUNT(作業区コード) AS INT) AS 発注件数 ,CAST(SUM(TRUNC(単価 * 発注数,0)) AS BIGINT) AS 発注金額 FROM T_発注 WHERE 納期 BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) GROUP BY 作業区コード ) AS A LEFT OUTER JOIN ( SELECT x.作業区コード ,CAST(COUNT(x.作業区コード) AS INT) AS 発注残件数 ,CAST(SUM(x.発注残金額) AS BIGINT) AS 発注残金額 FROM ( SELECT a.作業区コード ,CAST(TRUNC(a.単価 * (a.発注数 - COALESCE(b.完了数,0)),0) as BIGINT) AS 発注残金額 FROM T_発注 AS a LEFT OUTER JOIN ( SELECT 伝票番号 ,SUM(受入数) AS 完了数 FROM T_工程受入 GROUP BY 伝票番号 ) as b ON b.伝票番号 = a.伝票番号 WHERE a.納期 BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) AND NOT EXISTS (SELECT * FROM T_工程受入 WHERE 伝票番号 = a.伝票番号 AND 受入形態区分 IN ('1','2')) ) AS x GROUP BY x.作業区コード ) AS B ON B.作業区コード = A.作業区コード LEFT OUTER JOIN M_作業区仕入先 AS C ON C.作業区コード = A.作業区コード LEFT OUTER JOIN ( SELECT y.作業区コード ,CAST(SUM(y.発注残金額) AS BIGINT) AS 発注残金額 FROM ( SELECT x.作業区コード ,CASE WHEN x.工程順序No = 1 THEN CAST(TRUNC(x.単価 * (x.発注数 - x.自工程完了数),0) as BIGINT) ELSE CASE WHEN x.前工程完了数 > 0 THEN CASE WHEN x.前工程完了数 > x.自工程完了数 THEN CAST(TRUNC(x.単価 * (x.前工程完了数 - x.自工程完了数),0) as BIGINT) ELSE 0 END ELSE CASE WHEN x.自工程完了数 > 0 THEN CAST(TRUNC(x.単価 * (x.発注数 - x.自工程完了数),0) as BIGINT) ELSE CASE WHEN x.回答日有無 = 1 THEN CAST(TRUNC(x.単価 * x.発注数,0) as BIGINT) ELSE 0 END END END END AS 発注残金額 FROM ( SELECT a.伝票番号 ,a.管理No ,a.工程順序No ,a.作業区コード ,a.発注日 ,a.発注数 ,a.単価 ,CASE WHEN EXISTS (SELECT * FROM T_納期回答依頼 WHERE 管理No = a.管理No AND 工程順序No = (a.工程順序No - 1) AND 回答日 IS NOT NULL) THEN 1 ELSE 0 END AS 回答日有無 ,COALESCE(b.前工程完了数,0) AS 前工程完了数 ,COALESCE(c.自工程完了数,0) AS 自工程完了数 FROM T_発注 AS a LEFT OUTER JOIN ( SELECT 管理No ,工程順序No ,SUM(受入数) AS 前工程完了数 FROM T_工程受入 GROUP BY 管理No, 工程順序No ) AS b ON b.管理No = a.管理No AND b.工程順序No = (a.工程順序No - 1) LEFT OUTER JOIN ( SELECT 伝票番号 ,SUM(受入数) AS 自工程完了数 FROM T_工程受入 GROUP BY 伝票番号 ) AS c ON c.伝票番号 = a.伝票番号 WHERE a.納期 BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) AND NOT EXISTS (SELECT * FROM T_工程受入 WHERE 伝票番号 = a.伝票番号 AND 受入形態区分 IN ('1','2')) ) AS x ) AS y GROUP BY y.作業区コード ) AS D ON D.作業区コード = A.作業区コード
    -- SQL_REPORT_22_ORDERBY(%s2)
    ORDER BY COALESCE(C.表示順,0), A.作業区コード


