-- SQL_REPORT_64_SELECT_TEMPLATE
SELECT * FROM ( SELECT DISTINCT c.part_no ,c.engineering_change_no ,c.part_name ,COALESCE(d.stock_quantity,0) AS stock_quantity ,CASE WHEN d.bin_1 IS NULL THEN '' ELSE CASE WHEN d.bin_2 = '' THEN d.bin_1 ELSE d.bin_1 || '-' || d.bin_2 END END AS bin ,c.incoming_order_no ,c.branch_no ,a.acceptance_quantity AS 支給数 ,a.acceptance_DATE AS 支給日 ,CASE WHEN c.incoming_order_type IN ('1','4') THEN CASE WHEN f.management_no IS NULL THEN '' ELSE CASE WHEN f.test_type = false THEN CASE f.delivery_form_type WHEN '11' THEN 'END' WHEN '12' THEN 'STP' WHEN '13' THEN 'ING' ELSE '' END ELSE CASE f.test_result_type WHEN '0' THEN '依頼中' WHEN '1' THEN CASE f.delivery_form_type WHEN '11' THEN 'END' WHEN '12' THEN 'STP' WHEN '13' THEN 'ING' ELSE '' END WHEN '2' THEN '不合格' ELSE '' END END END ELSE CASE WHEN f.management_no IS NULL THEN '' ELSE CASE WHEN f.test_result_type = '2' THEN '不合格' ELSE CASE WHEN g.management_no IS NULL THEN '依頼中' ELSE CASE g.delivery_form_type WHEN '1' THEN '完納' WHEN '2' THEN '打切り' WHEN '3' THEN '分納' WHEN '4' THEN '過剰納入' ELSE '' END END END END END AS 状況 ,CASE WHEN c.incoming_order_type IN ('1','4') THEN CASE WHEN f.management_no IS NULL THEN NULL ELSE CASE WHEN f.test_type = false THEN NULL ELSE CASE f.test_result_type WHEN '0' THEN f.request_DATE ELSE NULL END END END ELSE CASE WHEN f.management_no IS NULL THEN NULL ELSE CASE WHEN f.test_result_type = '2' THEN NULL ELSE CASE WHEN g.management_no IS NULL THEN f.request_DATE ELSE NULL END END END END AS request_DATE ,COALESCE(h.process_sort_no, 0) AS process_no ,COALESCE(i.supplier_abbreviation,'') AS supplier_name ,COALESCE(j.acceptance_quantity,0) AS acceptance_quantity FROM t_process_acceptances AS a INNER JOIN t_production_plan_details AS b ON b.management_no = a.management_no AND b.process_sort_no = a.process_sort_no AND b.supplier_code = '448' AND b.process_code = '50' INNER JOIN t_incoming_orders AS c ON c.management_no = a.management_no LEFT OUTER JOIN ( SELECT part_no ,engineering_change_no ,stock_quantity ,CASE bin_1 WHEN '0' THEN '' WHEN '00' THEN '' ELSE bin_1 END AS bin_1 ,CASE bin_2 WHEN '0' THEN '' WHEN '00' THEN '' ELSE bin_2 END AS bin_2 FROM m_stocks ) AS d ON d.part_no = c.part_no AND d.engineering_change_no = c.engineering_change_no LEFT OUTER JOIN ( SELECT management_no, MAX(partial_delivery_no) AS partial_delivery_no FROM t_test_and_ship_requests GROUP BY management_no ) AS e ON e.management_no = a.management_no LEFT OUTER JOIN t_test_and_ship_requests AS f ON f.management_no = e.management_no AND f.partial_delivery_no = e.partial_delivery_no LEFT OUTER JOIN t_sales AS g ON g.management_no = f.management_no AND g.partial_delivery_no = f.partial_delivery_no LEFT OUTER JOIN t_placing_orders AS h ON h.management_no = a.management_no AND h.process_sort_no <> a.process_sort_no AND NOT EXISTS (SELECT * FROM t_process_acceptances WHERE management_no = h.management_no AND process_sort_no = h.process_sort_no AND acceptance_form_type IN ('1','2')) LEFT OUTER JOIN m_suppliers AS i ON i.supplier_code = h.supplier_code LEFT OUTER JOIN ( SELECT management_no ,process_sort_no ,SUM(acceptance_quantity) AS acceptance_quantity FROM t_process_acceptances GROUP BY management_no, process_sort_no ) AS j ON j.management_no = h.management_no AND j.process_sort_no = h.process_sort_no WHERE a.acceptance_DATE BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) ) AS A WHERE A.stock_quantity <> 0 OR A.状況 IN ('','ING','依頼中','分納') ORDER BY A.part_no, A.engineering_change_no, A.支給日, A.incoming_order_no, A.branch_no, A.process_no


