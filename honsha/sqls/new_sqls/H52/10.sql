-- SQL_REPORT_43_SELECT
SELECT CASE A.区分 WHEN '1' THEN '材料' ELSE '材料返' END AS 区分 ,A.supplier_code ,COALESCE(B.supplier_name,'') AS supplier_name ,A.material_name ,A.shape ,A.日付 ,A.weight ,A.material_unit ,A.unit_price ,A.仕入price ,COALESCE(C.supplier_abbreviation,'') AS 材料仕入先名 ,A.remarks FROM ( SELECT CASE WHEN a.purchase_type = '1' THEN 1 ELSE 2 END AS 区分 ,a.supplier_code AS supplier_code ,a.material_name ,a.shape ,a.deal_DATE AS 日付 ,a.weight ,CASE WHEN a.material_unit = '1' THEN 'kg' ELSE '本' END AS material_unit ,a.unit_price ,CASE WHEN a.purchase_type = '1' THEN a.price ELSE - a.price END AS 仕入price ,a.supply_target_code AS 材料supplier_code ,a.remarks FROM t_purchases AS a WHERE a.purchase_category_type = '1' AND a.supplier_code = ? AND a.deal_DATE BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) UNION ALL SELECT CASE WHEN b.purchase_type = '1' THEN 1 ELSE 2 END AS 区分 ,b.supply_target_code AS supplier_code ,b.material_name ,b.shape ,b.deal_DATE AS 日付 ,CASE WHEN b.purchase_type = '1' AND b.offset_method_type = '2' THEN c.weight ELSE b.weight END AS quantity_or_weight ,CASE WHEN b.material_unit = '1' THEN 'kg' ELSE '本' END AS material_unit ,b.unit_price ,CASE WHEN b.purchase_type = '1' AND b.offset_method_type = '1' THEN - b.supply_amount WHEN b.purchase_type = '1' AND b.offset_method_type = '2' THEN - c.offset_amount ELSE b.supply_amount END AS 仕入price ,b.supplier_code AS 材料supplier_code ,b.remarks FROM t_purchases AS b LEFT OUTER JOIN t_purchase_offsets AS c ON c.seq_no = b.seq_no WHERE b.purchase_category_type = '1' AND b.supply_target_code = ? AND CASE WHEN b.purchase_type = '1' AND b.offset_method_type = '2' THEN c.offset_DATE ELSE b.deal_DATE + interval'1 month' END BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) ) AS A LEFT OUTER JOIN m_suppliers AS B ON B.supplier_code = A.supplier_code LEFT OUTER JOIN m_suppliers AS C ON C.supplier_code = A.材料supplier_code ORDER BY A.日付, A.区分, A.material_name, A.shape


