-- SQL_REPORT_31_COUNT_TEMPLATE
SELECT CAST(COUNT(x.customer_code) AS INT) %s %s
-- SQL_REPORT_31_COMMON(%s1)
FROM ( SELECT 1 AS データ種別 ,b1.customer_code ,'売上' AS 区分 ,'' AS type ,b1.incoming_order_no ,b1.branch_no ,b1.part_no ,b1.engineering_change_no ,b1.part_name ,b1.customer_part_no ,a1.delivery_DATE ,b1.delivery_place_name ,CAST(NULL AS DATE) AS return_DATE ,b1.deadline ,a1.request_quantity AS quantity ,a1.unit_price ,a1.price ,CASE a1.delivery_form_type WHEN '1' THEN '完納' WHEN '2' THEN '打切り' WHEN '3' THEN '分納' WHEN '4' THEN '過剰納入' ELSE '' END AS 納入形態 ,'' AS issue_INT AUTO_INCREMENT_no FROM t_sales AS a1 INNER JOIN t_incoming_orders AS b1 ON b1.management_no = a1.management_no AND b1.incoming_order_type IN ('2','3') AND NOT (b1.customer_code = '1' AND LEFT(b1.incoming_order_no,1) ~ '^[0-9]+$') WHERE a1.delivery_DATE BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) UNION ALL SELECT 2 AS データ種別 ,b2.customer_code ,'売上' AS 区分 ,'kogo' AS type ,b2.incoming_order_no ,b2.branch_no ,b2.part_no ,b2.engineering_change_no ,b2.part_name ,b2.customer_part_no ,a2.delivery_DATE ,b2.delivery_place_name ,CAST(NULL AS DATE) AS return_DATE ,b2.deadline ,a2.request_quantity AS quantity ,a2.unit_price ,a2.price ,CASE a2.delivery_form_type WHEN '1' THEN '完納' WHEN '2' THEN '打切り' WHEN '3' THEN '分納' WHEN '4' THEN '過剰納入' ELSE '' END AS 納入形態 ,c2.issue_INT AUTO_INCREMENT_no FROM t_sales AS a2 INNER JOIN t_incoming_orders AS b2 ON b2.management_no = a2.management_no LEFT OUTER JOIN t_kogo AS c2 ON c2.issue_INT AUTO_INCREMENT_no = b2.incoming_order_barcode_no WHERE a2.delivery_DATE BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) AND b2.incoming_order_type IN ('2','3') AND b2.customer_code = '1' AND LEFT(b2.incoming_order_no,1) ~ '^[0-9]+$' AND ((b2.deadline >= '2018-01-01' AND COALESCE(c2.next_process_place_code,'') <> '') OR b2.deadline <= '2017-12-31') UNION ALL SELECT 2 AS データ種別 ,b3.customer_code ,'売上' AS 区分 ,'kogo' AS type ,b3.incoming_order_no ,b3.branch_no ,b3.part_no ,b3.engineering_change_no ,b3.part_name ,b3.customer_part_no ,a3.delivery_DATE ,b3.delivery_place_name ,CAST(NULL AS DATE) AS return_DATE ,b3.deadline ,a3.request_quantity AS quantity ,a3.unit_price ,a3.price ,CASE a3.delivery_form_type WHEN '1' THEN '完納' WHEN '2' THEN '打切り' WHEN '3' THEN '分納' WHEN '4' THEN '過剰納入' ELSE '' END AS 納入形態 ,c3.issue_INT AUTO_INCREMENT_no FROM t_sales AS a3 INNER JOIN t_incoming_orders AS b3 ON b3.management_no = a3.management_no AND b3.incoming_order_type IN ('2','3') AND b3.customer_code = '1' AND LEFT(b3.incoming_order_no,1) ~ '^[0-9]+$' AND b3.deadline >= '2018-01-01' LEFT OUTER JOIN t_kogo AS c3 ON c3.issue_INT AUTO_INCREMENT_no = b3.incoming_order_barcode_no WHERE a3.delivery_DATE BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) AND COALESCE(c3.next_process_place_code,'') = '' UNION ALL SELECT 4 AS データ種別 ,a4.customer_code ,'返品' AS 区分 ,'' AS type ,'' AS incoming_order_no ,'' AS branch_no ,a4.part_no ,a4.engineering_change_no ,COALESCE(b4.part_name,'') AS part_name ,'' AS customer_part_no ,CAST(NULL AS DATE) AS delivery_DATE ,'' AS delivery_place_name ,a4.return_DATE ,CAST(NULL AS DATE) AS deadline ,- a4.quantity AS quantity ,a4.unit_price ,- a4.price AS price ,'' AS 納入形態 ,'' AS issue_INT AUTO_INCREMENT_no FROM t_sales_returns AS a4 LEFT OUTER JOIN m_parts AS b4 ON b4.part_no = a4.part_no WHERE a4.return_DATE BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) UNION ALL SELECT 5 AS データ種別 ,a5.deal_code ,'売上' AS 区分 ,'' AS type ,'' AS incoming_order_no ,'' AS branch_no ,a5.part_no ,a5.engineering_change_no ,a5.part_name ,'' AS customer_part_no ,a5.sales_DATE AS delivery_DATE ,'' AS delivery_place_name ,CAST(NULL AS DATE) AS return_DATE ,CAST(NULL AS DATE) AS deadline ,a5.quantity ,a5.unit_price ,a5.price ,'' AS 納入形態 ,'' AS issue_INT AUTO_INCREMENT_no FROM t_sales_options AS a5 WHERE a5.sales_DATE BETWEEN CAST(CASE WHEN ? = '' THEN '2000-01-01' ELSE ? END as DATE) AND CAST(CASE WHEN ? = '' THEN '9999-12-31' ELSE ? END as DATE) AND a5.deal_type = '1' ) AS x LEFT OUTER JOIN m_customers AS y ON y.customer_code = x.customer_code WHERE x.customer_code = ?
    -- SQL_REPORT_31_WHERE_HINBAN(%s2)
    AND x.part_no &^ ?
    -- SQL_REPORT_31_ORDERBY(%s3)
    ORDER BY CASE データ種別 WHEN 4 THEN x.return_DATE ELSE x.delivery_DATE END ,x.データ種別 ,x.part_no ,x.incoming_order_no


