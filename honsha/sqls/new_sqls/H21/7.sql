-- SQL_SMC_GENPINHYOU
SELECT a.management_no ,a.partial_delivery_no ,CASE b.incoming_order_data_type WHEN 'A' THEN COALESCE(c.item_tag_form_type,'') WHEN 'K' THEN COALESCE(d.item_tag_form_type,'') WHEN 'C' THEN COALESCE(d.item_tag_form_type,'') ELSE '' END AS item_tag_form_type ,CASE WHEN b.customer_part_no = '' THEN b.part_no ELSE b.customer_part_no END AS part_no ,e.quantity AS quantity ,e.packing_quantity AS 箱数 ,f.ship_quantity ,f.total_box_quantity ,b.delivery_place_name ,CASE b.incoming_order_data_type WHEN 'A' THEN COALESCE(c.bin,'') WHEN 'K' THEN COALESCE(d.bin,'') WHEN 'C' THEN COALESCE(d.bin,'') ELSE '' END AS bin ,CASE WHEN STRPOS(b.delivery_place_name,'部品中継') <> 0 THEN '1' WHEN b.incoming_order_data_type = 'A' THEN COALESCE(c.relay_type,'') WHEN b.incoming_order_data_type IN ('K','C') THEN COALESCE(d.relay_type,'') ELSE '' END AS relay_type ,b.next_process_name ,b.part_name ,b.engineering_change_no ,a.delivery_DATE ,b.biller ,CASE b.incoming_order_data_type WHEN 'A' THEN COALESCE(c.arrangement_no,'') ELSE '' END AS arrangement_no ,CASE b.incoming_order_data_type WHEN 'A' THEN COALESCE(c.order_no,'') WHEN 'K' THEN COALESCE(d.issue_INT AUTO_INCREMENT_no,'') WHEN 'C' THEN COALESCE(d.issue_INT AUTO_INCREMENT_no,'') ELSE '' END AS 注番 ,CASE b.incoming_order_data_type WHEN 'A' THEN CASE WHEN LENGTH(COALESCE(c.management_no,'')) < 15 THEN SUBSTRING(COALESCE(c.management_no,''), 4, 15) ELSE CASE WHEN LENGTH(RTRIM(COALESCE(c.kogo,''))) = 0 THEN COALESCE(c.preparation_no,'') ELSE COALESCE(c.kogo,'') END END WHEN 'K' THEN COALESCE(d.kogo,'') WHEN 'C' THEN COALESCE(d.kogo,'') ELSE '' END AS kogo ,b.tapered_screw_type ,CASE b.incoming_order_data_type WHEN 'A' THEN RIGHT(COALESCE(c.order_no,''),3) WHEN 'K' THEN RIGHT(COALESCE(d.issue_INT AUTO_INCREMENT_no,''),3) WHEN 'C' THEN RIGHT(COALESCE(d.issue_INT AUTO_INCREMENT_no,''),3) ELSE '' END AS 注番2 ,CASE b.incoming_order_data_type WHEN 'A' THEN LEFT(COALESCE(c.report_no,''), 8) WHEN 'K' THEN COALESCE(d.issue_INT AUTO_INCREMENT_no,'') WHEN 'C' THEN COALESCE(d.issue_INT AUTO_INCREMENT_no,'') ELSE '' END AS report_no ,CASE b.incoming_order_data_type WHEN 'A' THEN RIGHT(COALESCE(c.report_no,''), 2) WHEN 'K' THEN '01' WHEN 'C' THEN '01' ELSE '' END AS report_INT AUTO_INCREMENT_no FROM t_sales AS a INNER JOIN t_incoming_orders AS b ON b.management_no = a.management_no LEFT OUTER JOIN t_kobai_juchu AS c ON c.report_no = b.incoming_order_barcode_no LEFT OUTER JOIN t_kogo AS d ON d.issue_INT AUTO_INCREMENT_no = b.incoming_order_barcode_no INNER JOIN t_sales_details AS e ON e.management_no = a.management_no AND e.partial_delivery_no = a.partial_delivery_no INNER JOIN ( SELECT management_no ,partial_delivery_no ,SUM(quantity * packing_quantity) AS ship_quantity ,SUM(packing_quantity) AS total_box_quantity FROM t_sales_details GROUP BY management_no, partial_delivery_no ) AS f ON f.management_no = a.management_no AND f.partial_delivery_no = a.partial_delivery_no WHERE (a.management_no = ? AND a.partial_delivery_no = ?)
    -- SQL_SMC_GENPINHYOU_WHERE(n回繰り返し)
    OR (a.management_no = ? AND a.partial_delivery_no = ?)
-- SQL_SMC_GENPINHYOU_ORDER
ORDER BY item_tag_form_type, b.part_no, b.engineering_change_no, a.management_no, a.partial_delivery_no, e.seq_no


