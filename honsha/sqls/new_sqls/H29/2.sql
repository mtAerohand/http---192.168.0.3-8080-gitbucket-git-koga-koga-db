-- SQL_CYCLE_BILLING_DETAIL
INSERT INTO t_acceptance_test_details( payment_month ,supplier_code ,deal_DATE ,incoming_order_no ,branch_no ,part_no_material ,engineering_change_no ,detail_type ,quantity_or_weight ,unit_price ,price ,remarks ,version_no ,upDATEd_at ,upDATEd_by) SELECT ? AS payment_month ,A.supplier_code ,A.deal_DATE ,A.incoming_order_no ,A.branch_no ,A.part_no_material ,A.engineering_change_no ,A.detail_type ,A.quantity_or_weight ,A.unit_price ,A.price ,A.remarks ,1 AS version_no ,CURRENT_TIMESTAMP AS upDATEd_at ,? AS upDATEd_by FROM ( SELECT c1.supplier_code ,a1.acceptance_DATE AS deal_DATE ,b1.incoming_order_no ,b1.branch_no ,b1.part_no AS part_no_material ,b1.engineering_change_no ,CASE WHEN a1.acceptance_form_type IN ('2','3') THEN '4' ELSE '1' END AS detail_type ,a1.acceptance_quantity AS quantity_or_weight ,a1.unit_price ,a1.price ,'' AS remarks FROM t_process_acceptances AS a1 INNER JOIN t_incoming_orders AS b1 ON b1.management_no = a1.management_no INNER JOIN t_placing_orders AS c1 ON c1.placing_order_no = a1.placing_order_no WHERE a1.acceptance_DATE BETWEEN CAST(? as DATE) AND (CAST(? as DATE) + interval '1 month' ) - interval '1 day' UNION ALL SELECT a2.supplier_code ,a2.return_DATE AS deal_DATE ,b2.incoming_order_no ,b2.branch_no ,b2.part_no AS part_no_material ,b2.engineering_change_no ,'3' AS detail_type ,a2.quantity AS quantity_or_weight ,a2.unit_price ,- a2.price AS price ,a2.remarks FROM t_acceptance_returns AS a2 INNER JOIN t_incoming_orders AS b2 ON b2.management_no = a2.management_no WHERE a2.return_DATE BETWEEN CAST(? as DATE) AND (CAST(? as DATE) + interval '1 month' ) - interval '1 day' UNION ALL SELECT a3.supplier_code AS supplier_code ,a3.deal_DATE ,'' AS incoming_order_no ,'' AS branch_no ,CASE WHEN a3.purchase_category_type = '1' THEN a3.material_name ELSE a3.part_no END AS part_no_material ,a3.engineering_change_no ,CASE WHEN a3.purchase_type = '1' THEN '1' ELSE '3' END AS detail_type ,CASE WHEN a3.purchase_category_type = '1' THEN a3.weight ELSE a3.quantity END AS quantity_or_weight ,a3.unit_price ,CASE WHEN a3.purchase_type = '1' THEN a3.price ELSE - a3.price END AS price ,a3.remarks FROM t_purchases AS a3 WHERE a3.deal_DATE BETWEEN CAST(? as DATE) AND (CAST(? as DATE) + interval '1 month' ) - interval '1 day' UNION ALL SELECT a4.supply_target_code AS supplier_code ,a4.deal_DATE ,'' AS incoming_order_no ,'' AS branch_no ,a4.material_name AS part_no_material ,'' AS engineering_change_no ,'2' AS detail_type ,CASE WHEN a4.purchase_type = '1' AND a4.offset_method_type = '2' THEN c4.weight ELSE a4.weight END AS quantity_or_weight ,a4.unit_price ,CASE WHEN a4.purchase_type = '1' AND a4.offset_method_type = '1' THEN - a4.supply_amount WHEN a4.purchase_type = '1' AND a4.offset_method_type = '2' THEN - c4.offset_amount ELSE a4.supply_amount END AS price ,COALESCE(b4.supplier_abbreviation,'') AS remarks FROM t_purchases AS a4 LEFT OUTER JOIN m_suppliers AS b4 ON b4.supplier_code = a4.supplier_code LEFT OUTER JOIN t_purchase_offsets AS c4 ON c4.seq_no = a4.seq_no WHERE a4.purchase_category_type = '1' AND CASE WHEN a4.purchase_type = '1' AND a4.offset_method_type = '2' THEN c4.offset_DATE ELSE a4.deal_DATE + interval '1 month' END BETWEEN CAST(? as DATE) AND (CAST(? as DATE) + interval '1 month' ) - interval '1 day' UNION ALL SELECT a5.deal_code AS supplier_code ,a5.sales_DATE AS deal_DATE ,'' AS incoming_order_no ,'' AS branch_no ,a5.part_no AS part_no_material ,a5.engineering_change_no ,'2' AS detail_type ,a5.quantity AS quantity_or_weight ,a5.unit_price ,- a5.price AS price ,'' AS remarks FROM t_sales_options AS a5 WHERE a5.deal_type = '2' AND a5.sales_DATE BETWEEN CAST(? as DATE) AND (CAST(? as DATE) + interval '1 month' ) - interval '1 day' ) AS A INNER JOIN m_suppliers AS B ON B.supplier_code = A.supplier_code AND B.acceptance_report_type = true ORDER BY A.supplier_code, A.deal_DATE, A.part_no_material


