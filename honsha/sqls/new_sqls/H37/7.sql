-- SQL_GETHISTORYLIST_SELECT
SELECT * FROM ( SELECT b.part_no ,b.engineering_change_no ,COALESCE(c.part_name,'') AS part_name ,a.acceptance_DATE AS 入出庫日 ,'仕入' AS 受払区分 ,a.acceptance_quantity ,0 AS 払出数 ,b.incoming_order_no ,b.branch_no ,'' AS remarks ,'' AS bin ,4 AS 順位 ,CAST(NULL as TIMESTAMP) AS upDATEd_at FROM t_process_acceptances AS a INNER JOIN t_incoming_orders AS b ON b.management_no = a.management_no AND b.part_no = ? AND b.engineering_change_no = ? INNER JOIN t_placing_orders AS d ON d.management_no = a.management_no AND d.process_sort_no = a.process_sort_no AND d.final_process_type = true LEFT OUTER JOIN m_parts AS c ON c.part_no = b.part_no UNION ALL SELECT b.part_no ,b.engineering_change_no ,COALESCE(c.part_name,'') AS part_name ,a.delivery_DATE AS 入出庫日 ,'売上' AS 受払区分 ,0 AS acceptance_quantity ,a.request_quantity AS 払出数 ,b.incoming_order_no ,b.branch_no ,'' AS remarks ,'' AS bin ,2 AS 順位 ,CAST(NULL as TIMESTAMP) AS upDATEd_at FROM t_sales AS a INNER JOIN t_incoming_orders AS b ON b.management_no = a.management_no AND b.part_no = ? AND b.engineering_change_no = ? LEFT OUTER JOIN m_parts AS c ON c.part_no = b.part_no UNION ALL SELECT a.part_no ,a.engineering_change_no ,COALESCE(b.part_name,'') AS part_name ,a.registration_DATE AS 入出庫日 ,'調整' AS 受払区分 ,CASE WHEN a.adjustment_quantity > 0 THEN a.adjustment_quantity ELSE 0 END AS acceptance_quantity ,CASE WHEN a.adjustment_quantity < 0 THEN ABS(a.adjustment_quantity) ELSE 0 END AS 払出数 ,'' AS incoming_order_no ,'' AS branch_no ,a.remarks ,CASE WHEN a.bin_2 = '' THEN a.bin_1 ELSE a.bin_1 || '-' || a.bin_2 END AS bin ,1 AS 順位 ,a.upDATEd_at FROM t_receipt_and_payments AS a LEFT OUTER JOIN m_parts AS b ON b.part_no = a.part_no WHERE a.part_no = ? AND a.engineering_change_no = ? UNION ALL SELECT b.part_no ,b.engineering_change_no ,COALESCE(c.part_name,'') AS part_name ,a.return_DATE AS 入出庫日 ,'返品' AS 受払区分 ,0 AS acceptance_quantity ,a.quantity AS 払出数 ,b.incoming_order_no ,b.branch_no ,'' AS remarks ,'' AS bin ,3 AS 順位 ,CAST(NULL as TIMESTAMP) AS upDATEd_at FROM t_acceptance_returns AS a INNER JOIN t_incoming_orders AS b ON b.management_no = a.management_no AND b.part_no = ? AND b.engineering_change_no = ? LEFT OUTER JOIN m_parts AS c ON c.part_no = b.part_no ) AS x ORDER BY x.入出庫日 DESC, x.順位, x.upDATEd_at DESC
