-- SQL_GET_REQUEST
SELECT A.management_no ,A.supplier_code ,COALESCE(B.supplier_name,'') AS supplier_name ,A.supplier_manager_name ,A.manager_code ,COALESCE(C.employee_name,'') AS manager_name ,CURRENT_DATE + interval '2 day' AS response_deadline日 ,'15' AS response_deadline時刻 ,CASE WHEN COALESCE(F.comment,'') = '' THEN 'よろしくお願い申し上げます。' ELSE F.comment END AS comment FROM ( /* 通常 */ SELECT management_no ,supplier_code ,supplier_manager_name ,manager_code FROM t_deadline_response_requests WHERE has_response_request = true AND request_report_type = '1' UNION ALL /* 多工程 */ SELECT c.management_no ,c.supplier_code ,c.supplier_manager_name ,c.manager_code FROM ( SELECT management_no ,MIN(process_sort_no) AS 先頭process_sort_no FROM t_deadline_response_requests WHERE has_response_request = true AND request_report_type = '2' GROUP BY management_no ) AS a INNER JOIN ( SELECT management_no ,process_sort_no ,MIN(partial_delivery_no) AS 先頭partial_delivery_no FROM t_deadline_response_requests WHERE has_response_request = true AND request_report_type = '2' GROUP BY management_no, process_sort_no ) AS b ON b.management_no = a.management_no AND b.process_sort_no = a.先頭process_sort_no INNER JOIN t_deadline_response_requests AS c ON c.management_no = b.management_no AND c.process_sort_no = b.process_sort_no AND c.partial_delivery_no = b.先頭partial_delivery_no ) AS A LEFT OUTER JOIN m_suppliers AS B ON B.supplier_code = A.supplier_code LEFT OUTER JOIN m_employees AS C ON C.employee_code = A.manager_code INNER JOIN t_incoming_orders AS D ON D.management_no = A.management_no LEFT OUTER JOIN ( SELECT management_no ,MAX(demand_DATE) AS demand_DATE FROM t_deadline_response_requests WHERE demand_DATE IS NOT NULL GROUP BY management_no ) AS E ON E.management_no = A.management_no LEFT OUTER JOIN ( SELECT DISTINCT management_no ,demand_DATE ,comment FROM t_deadline_response_requests ) AS F ON F.management_no = E.management_no AND F.demand_DATE = E.demand_DATE WHERE A.management_no = CAST(? AS INT)


