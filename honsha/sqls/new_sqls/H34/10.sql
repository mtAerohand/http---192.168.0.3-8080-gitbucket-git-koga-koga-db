-- SQL_GET_FAX
SELECT A.management_no ,A.supplier_code ,COALESCE(B.supplier_name,'') AS supplier_name ,A.supplier_manager_name ,A.manager_code ,COALESCE(C.employee_name,'') AS manager_name ,D.incoming_order_no ,D.part_name ,D.part_no ,D.engineering_change_no ,CASE WHEN E.request_report_type = '1' THEN '' ELSE CAST(E.process_sort_no as VARCHAR) END AS process_sort_no ,CASE WHEN E.request_report_type = '1' THEN '' ELSE F.supplier_code END AS supplier_code ,CASE WHEN E.request_report_type = '1' THEN '' ELSE COALESCE(G.supplier_abbreviation,'') END AS supplier_name ,F.process_code ,COALESCE(H.process_abbreviation,'') AS process_name ,F.deadline ,E.requested_delivery_DATE ,COALESCE(J.acceptance_DATE, I.response_DATE) AS 前工程deadline ,E.requested_delivery_quantity ,E.request_report_type ,CASE WHEN E.request_report_type = '1' THEN CAST(E.requested_delivery_DATE as VARCHAR) ELSE CAST(A.先頭requested_delivery_DATE as VARCHAR) END AS SORT1 ,CASE WHEN E.request_report_type = '1' THEN D.part_no ELSE D.incoming_order_no END AS SORT2 ,CASE WHEN E.request_report_type = '1' THEN '' ELSE CAST(E.partial_delivery_no as VARCHAR) END AS SORT3 ,CASE WHEN E.request_report_type = '1' THEN '' ELSE CAST(E.process_sort_no as VARCHAR) END AS SORT4 ,D.branch_no FROM ( /* 通常 */ SELECT DISTINCT management_no ,supplier_code ,supplier_manager_name ,manager_code ,CAST(NULL AS DATE) AS 先頭requested_delivery_DATE FROM t_deadline_response_requests WHERE has_response_request = true AND request_report_type = '1' AND contact_method_type = '2' UNION ALL /* 多工程 */ SELECT c.management_no ,c.supplier_code ,c.supplier_manager_name ,c.manager_code ,c.requested_delivery_DATE AS 先頭requested_delivery_DATE FROM ( SELECT management_no ,MIN(process_sort_no) AS 先頭process_sort_no FROM t_deadline_response_requests WHERE has_response_request = true AND request_report_type = '2' AND contact_method_type = '2' GROUP BY management_no ) AS a INNER JOIN ( SELECT management_no ,process_sort_no ,MIN(partial_delivery_no) AS 先頭partial_delivery_no FROM t_deadline_response_requests WHERE has_response_request = true AND request_report_type = '2' GROUP BY management_no, process_sort_no ) AS b ON b.management_no = a.management_no AND b.process_sort_no = a.先頭process_sort_no INNER JOIN t_deadline_response_requests AS c ON c.management_no = b.management_no AND c.process_sort_no = b.process_sort_no AND c.partial_delivery_no = b.先頭partial_delivery_no ) AS A LEFT OUTER JOIN m_suppliers AS B ON B.supplier_code = A.supplier_code LEFT OUTER JOIN m_employees AS C ON C.employee_code = A.manager_code INNER JOIN t_incoming_orders AS D ON D.management_no = A.management_no INNER JOIN t_deadline_response_requests AS E ON E.management_no = A.management_no AND E.has_response_request = true INNER JOIN t_production_plan_details AS F ON F.management_no = E.management_no AND F.process_sort_no = E.process_sort_no LEFT OUTER JOIN m_suppliers AS G ON G.supplier_code = F.supplier_code LEFT OUTER JOIN m_processes AS H ON H.process_code = F.process_code LEFT OUTER JOIN t_deadline_response_requests AS I ON I.management_no = E.management_no AND I.process_sort_no = (E.process_sort_no - 1) AND I.partial_delivery_no = E.partial_delivery_no LEFT OUTER JOIN t_process_acceptances AS J ON J.management_no = E.management_no AND J.process_sort_no = (E.process_sort_no - 1) AND J.partial_delivery_no = E.partial_delivery_no WHERE A.management_no
-- H34/796
IN (?)
-- SQL_GET_FAX_ORDER
ORDER BY SORT1, SORT2, SORT3, SORT4


