-- SQL_OUTPUT_DATA
SELECT a.management_no ,a.partial_delivery_no ,COALESCE(a.output_DATE,CURRENT_DATE) AS issue_DATE ,b.incoming_order_no ,b.branch_no ,a.alternative_incoming_order_no ,a.alternative_branch_no ,a.alternative_management_no ,b.part_no ,b.engineering_change_no ,b.part_name ,CASE WHEN COALESCE(c.bin_2,'') = '' THEN COALESCE(c.bin_1,'') ELSE COALESCE(c.bin_1,'') || '-' || COALESCE(c.bin_2,'') END AS bin ,CASE a.ship_type WHEN '0' THEN '先行手配' WHEN '1' THEN '振替出荷' WHEN '2' THEN '在庫出荷' WHEN '3' THEN '通常出荷' ELSE '' END AS ship_type ,COALESCE(f.bucket_infomation,'') AS 納入バケット ,CASE WHEN g.part_no IS NULL THEN '' ELSE '管理図面' END AS 図面type ,a.remarks_1 ,a.remarks_2 ,COALESCE(h.supplier_code,'') AS supplier_code ,COALESCE(k.supplier_name,'') AS supplier_name ,j.acceptance_DATE ,b.manager_code ,COALESCE(l.employee_name,'') AS manager_name ,b.incoming_order_DATE ,b.incoming_order_quantity ,COALESCE(c.stock_quantity,0) AS stock_quantity ,b.deadline ,a.production_quantity ,a.delivery_DATE ,a.request_quantity ,a.response_DATE ,a.test_report ,CASE a.ship_service_type WHEN '1' THEN '赤帽便' WHEN '2' THEN 'ヤマト便' WHEN '3' THEN '佐川便' WHEN '4' THEN '営業届け' WHEN '5' THEN 'その他' ELSE '' END AS ship_service_type ,a.packing_type ,CASE a.delivery_form_type WHEN '1' THEN '完納' WHEN '2' THEN '打切り' WHEN '3' THEN '分納' WHEN '4' THEN '過剰納入' WHEN '11' THEN 'END' WHEN '12' THEN 'STP' WHEN '13' THEN 'ING' ELSE '' END AS 納入形態 ,a.delivery_place_name ,b.customer_code ,COALESCE(o.customer_name,'') AS customer_name ,a.ship_type ,a.test_type ,a.version_no ,b.tapered_screw_type ,b.test_report_attached_type ,COALESCE(b.customer_part_no, '') AS customer_part_no ,COALESCE(q.material_name, '') AS material_name ,COALESCE(p.packing_method, '') AS packing_method ,COALESCE(p.packing_caution, '') AS packing_caution ,COALESCE(p.customer_claim_history, '') AS customer_claim_history FROM t_test_and_ship_requests AS a INNER JOIN t_incoming_orders AS b ON b.management_no = a.management_no LEFT OUTER JOIN m_stocks AS c ON c.part_no = b.part_no AND c.engineering_change_no = b.engineering_change_no LEFT OUTER JOIN t_kobai_juchu AS d ON d.report_no = b.incoming_order_barcode_no LEFT OUTER JOIN t_kogo AS e ON e.issue_INT AUTO_INCREMENT_no = b.incoming_order_barcode_no LEFT OUTER JOIN m_delivery_buckets AS f ON f.biller = b.billerAND f.next_process_code = b.next_process_code LEFT OUTER JOIN ( SELECT DISTINCT part_no FROM t_drawings WHERE drawing_type = '1' ) AS g ON g.part_no = b.part_no LEFT OUTER JOIN t_placing_orders AS h ON h.management_no = (CASE WHEN a.alternative_management_no = 0 THEN a.management_no ELSE a.alternative_management_no END)AND h.final_process_type = true LEFT OUTER JOIN ( SELECT placing_order_no, MAX(partial_delivery_no) AS partial_delivery_no FROM t_process_acceptances GROUP BY placing_order_no ) AS i ON i.placing_order_no = h.placing_order_no LEFT OUTER JOIN t_process_acceptances AS j ON j.placing_order_no = i.placing_order_no AND j.partial_delivery_no = i.partial_delivery_no LEFT OUTER JOIN m_suppliers AS k ON k.supplier_code = h.supplier_code LEFT OUTER JOIN m_employees AS l ON l.employee_code = b.manager_code LEFT OUTER JOIN m_customers AS o ON o.customer_code = b.customer_code LEFT OUTER JOIN m_packings AS p ON p.part_no = b.part_no LEFT OUTER JOIN m_materials AS q ON q.material_code = p.material_code WHERE a.management_no = ? AND a.partial_delivery_no = ?
