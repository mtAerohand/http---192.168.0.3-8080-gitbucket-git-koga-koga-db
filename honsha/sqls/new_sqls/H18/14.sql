-- SQL_GET_NEW_KENSA
SELECT a.management_no ,COALESCE(b.partial_delivery_no,0) + 1 AS partial_delivery_no ,a.incoming_order_no ,a.branch_no ,a.customer_code ,COALESCE(c.customer_name,'') AS customer_name ,a.part_no ,a.engineering_change_no ,a.part_name ,a.manager_code ,COALESCE(d.employee_name,'') AS manager_name ,a.incoming_order_type ,CASE a.incoming_order_type WHEN '1' THEN '先行手配 ' WHEN '2' THEN '受注' WHEN '3' THEN '受注' ELSE '再納' END AS incoming_order_type名 ,'0' AS ship_type ,'' AS alternative_incoming_order_no ,'' AS alternative_branch_no ,0 AS alternative_management_no ,1 AS test_type ,COALESCE(e.stock_quantity,0) - COALESCE(e.ship_request_quantity,0) AS 有効stock_quantity ,COALESCE(e.stock_quantity,0) AS stock_quantity ,COALESCE(e.suspense_stock_quantity,0) AS suspense_stock_quantity ,COALESCE(e.ship_request_quantity,0) AS ship_request_quantity ,a.incoming_order_quantity - (COALESCE(g.test有完了数,0) + COALESCE(h.test無request_quantity,0) + COALESCE(f.納quantity,0)) AS 受注残数 ,a.incoming_order_quantity ,a.incoming_order_DATE ,COALESCE(n.acceptance_quantity計,0) - COALESCE(o.request_quantity計,0) AS production_quantity ,COALESCE(l.supplier_abbreviation,'') AS supplier_name ,k.acceptance_DATE ,COALESCE(n.acceptance_quantity計,0) - COALESCE(o.request_quantity計,0) AS request_quantity ,a.unit ,'11' AS delivery_form_type ,a.deadline ,m.response_DATE ,NULL AS delivery_DATE ,0 AS test_report ,e.packing_type ,'1' AS ship_service_type ,a.delivery_place_name ,a.request_remarks_1 ,a.request_remarks_2 ,0 AS version_no FROM t_incoming_orders AS a LEFT OUTER JOIN( SELECT management_no, MAX(partial_delivery_no) AS partial_delivery_no FROM t_test_and_ship_requests GROUP BY management_no ) AS b ON b.management_no = a.management_no LEFT OUTER JOIN m_customers AS c ON c.customer_code = a.customer_code LEFT OUTER JOIN m_employees AS d ON d.employee_code = a.manager_code LEFT OUTER JOIN m_stocks AS e ON e.part_no = a.part_no AND e.engineering_change_no = a.engineering_change_no LEFT OUTER JOIN ( /* 出荷有りの完了数 */ SELECT x.management_no, SUM(x.request_quantity) AS 納quantity FROM t_sales AS x INNER JOIN t_test_and_ship_requests AS y ON y.management_no = x.management_no AND y.partial_delivery_no = x.partial_delivery_no AND y.ship_type <> '0' GROUP BY x.management_no ) AS f ON f.management_no = a.management_no LEFT OUTER JOIN ( /* 出荷無し/test有りの完了数 */ SELECT management_no, SUM(request_quantity) AS test有完了数 FROM t_test_and_ship_requests WHERE ship_type = '0' AND test_type = true AND test_result_type <> '0' GROUP BY management_no ) AS g ON g.management_no = a.management_no LEFT OUTER JOIN ( /* 出荷無し/test無しの完了数 */ SELECT management_no, SUM(request_quantity) AS test無request_quantity FROM t_test_and_ship_requests WHERE ship_type = '0' AND test_type = false GROUP BY management_no ) AS h ON h.management_no = a.management_no LEFT OUTER JOIN t_placing_orders AS i ON i.management_no = a.management_no AND i.final_process_type = true LEFT OUTER JOIN ( SELECT management_no, process_sort_no, MAX(partial_delivery_no) AS partial_delivery_no FROM t_process_acceptances GROUP BY management_no, process_sort_no ) AS j ON j.management_no = i.management_no AND j.process_sort_no = i.process_sort_no LEFT OUTER JOIN t_process_acceptances AS k ON k.management_no = i.management_no AND k.process_sort_no = i.process_sort_no AND k.partial_delivery_no = j.partial_delivery_no LEFT OUTER JOIN m_suppliers AS l ON l.supplier_code = i.supplier_code LEFT OUTER JOIN ( SELECT management_no, process_sort_no, SUM(acceptance_quantity) AS acceptance_quantity計 FROM t_process_acceptances GROUP BY management_no, process_sort_no ) AS n ON n.management_no = i.management_no AND n.process_sort_no = i.process_sort_no LEFT OUTER JOIN ( SELECT management_no, SUM(request_quantity) AS request_quantity計 FROM t_test_and_ship_requests WHERE ship_type IN ('0','3') GROUP BY management_no ) AS o ON o.management_no = i.management_no LEFT OUTER JOIN t_deadline_responses AS m ON m.management_no = a.management_no AND m.partial_delivery_no = COALESCE(b.partial_delivery_no,0) + 1 WHERE a.management_no = CAST(? as INT)


