-- SQL_GET_EDIT
SELECT a.management_no ,a.partial_delivery_no ,b.incoming_order_no ,b.branch_no ,b.customer_code ,COALESCE(c.customer_name,'') AS customer_name ,b.part_no ,b.engineering_change_no ,b.part_name ,b.manager_code ,COALESCE(d.employee_name,'') AS manager_name ,b.incoming_order_type ,CASE b.incoming_order_type WHEN '1' THEN '先行手配' WHEN '2' THEN '受注' WHEN '3' THEN '受注' ELSE '再納' END AS incoming_order_type名 ,a.ship_type ,a.alternative_incoming_order_no ,a.alternative_branch_no ,a.alternative_management_no ,a.test_type ,COALESCE(e.stock_quantity,0) - COALESCE(e.ship_request_quantity,0) AS 有効stock_quantity ,COALESCE(e.stock_quantity,0) AS stock_quantity ,COALESCE(e.suspense_stock_quantity,0) AS suspense_stock_quantity ,COALESCE(e.ship_request_quantity,0) AS ship_request_quantity ,b.incoming_order_quantity - (COALESCE(g.test有完了数,0) + COALESCE(h.test無request_quantity,0) + COALESCE(f.納quantity,0)) AS 受注残数 ,b.incoming_order_quantity ,b.incoming_order_DATE ,a.production_quantity ,COALESCE(l.supplier_abbreviation,'') AS supplier_name ,k.acceptance_DATE ,a.request_quantity ,b.unit ,a.delivery_form_type ,b.deadline ,a.response_DATE ,a.delivery_DATE ,a.test_report ,a.packing_type ,a.ship_service_type ,a.delivery_place_name ,a.remarks_1 ,a.remarks_2 ,a.version_no FROM t_test_and_ship_requests AS a INNER JOIN t_incoming_orders AS b ON b.management_no = a.management_no LEFT OUTER JOIN m_customers AS c ON c.customer_code = b.customer_code LEFT OUTER JOIN m_employees AS d ON d.employee_code = b.manager_code LEFT OUTER JOIN m_stocks AS e ON e.part_no = b.part_no AND e.engineering_change_no = b.engineering_change_no LEFT OUTER JOIN ( /* 出荷有りの完了数 */ SELECT x.management_no, SUM(x.request_quantity) AS 納quantity FROM t_sales AS x INNER JOIN t_test_and_ship_requests AS y ON y.management_no = x.management_no AND y.partial_delivery_no = x.partial_delivery_no AND y.ship_type <> '0' GROUP BY x.management_no ) AS f ON f.management_no = a.management_no LEFT OUTER JOIN ( /* 出荷無し/test有りの完了数 */ SELECT management_no, SUM(request_quantity) AS test有完了数 FROM t_test_and_ship_requests WHERE ship_type = '0' AND test_type = true AND test_result_type <> '0' GROUP BY management_no ) AS g ON g.management_no = a.management_no LEFT OUTER JOIN ( /* 出荷無し/test無しの完了数 */ SELECT management_no, SUM(request_quantity) AS test無request_quantity FROM t_test_and_ship_requests WHERE ship_type = '0' AND test_type = false AND partial_delivery_no <> CAST(? as INT) GROUP BY management_no ) AS h ON h.management_no = a.management_no LEFT OUTER JOIN t_placing_orders AS i ON i.management_no = (CASE WHEN a.alternative_management_no = 0 THEN a.management_no ELSE a.alternative_management_no END) AND i.final_process_type = true LEFT OUTER JOIN ( SELECT management_no, process_sort_no, MAX(partial_delivery_no) AS partial_delivery_no FROM t_process_acceptances GROUP BY management_no, process_sort_no ) AS j ON j.management_no = i.management_no AND j.process_sort_no = i.process_sort_no LEFT OUTER JOIN t_process_acceptances AS k ON k.management_no = i.management_no AND k.process_sort_no = i.process_sort_no AND k.partial_delivery_no = j.partial_delivery_no LEFT OUTER JOIN m_suppliers AS l ON l.supplier_code = i.supplier_code WHERE a.management_no = CAST(? as INT) AND a.partial_delivery_no = CAST(? as INT)


